geekApp.constant('currencies',[{'value':'USD','name':'USD','symbol':'US$'},{'value':'EUR','name':'EUR','symbol':'€'},{'value':'GBP','name':'GBP','symbol':'£'},{'value':'CAD','name':'CAD','symbol':'C$'},{'value':'AUD','name':'AUD','symbol':'A$'},{'value':'YEN','name':'YEN','symbol':'¥'},{'value':'','name':'Other','symbol':''}]);geekApp.controller('GeekCollection_DeleteItemCtrl',['$scope','$uibModalInstance','item',function($scope,$uibModalInstance,item){$scope.item=item;$scope.ok=function(){$uibModalInstance.close();};$scope.cancel=function(){$uibModalInstance.dismiss('cancel');};}]);
geekApp.factory('collectionData',['collectionHttpTools','collectionUtils','userid','currencies','$q','$rootScope','notify',function(collectionHttpTools,collectionUtils,userid,currencies,$q,$rootScope,notify){return function(params){var that=this;that.params=angular.copy(params);that.items=[];that.config=null;that.ratingitem=null;that.statuses=[];that.versionstatuses={};var statusWatchActive=true;var statusWatchers=[];this.activateStatusWatchers=function(){statusWatchActive=true;};this.deactivateStatusWatchers=function(){statusWatchActive=false;};this.initRatingItem=function(params){this.ratingitem={collid:0,objecttype:params.objecttype,objectid:params.objectid,rating:0};};this.updateItem=function(item,skipReload){collectionHttpTools.updateItem(item).then(function(){notify.closeAll();notify("Status updated");if(skipReload){that.statuses=getStatuses(that.items);}else{that.getItems({objecttype:item.objecttype,objectid:item.objectid},true);}});};var getStatuses=function(items){return _(items).map(function(item){return _(_.get(item,'status')).pick(_.identity).keys().value();}).flatten().uniq().sort().value();};this.getItems=function(paramsIn,force){if(userid){var params=angular.copy(paramsIn);params.userid=userid;if(force)
collectionHttpTools.clearCache();that.loadingItems=true;return collectionHttpTools.getItems(params).then(function(response){that.items=response.data.items;that.items=_.map(that.items,collectionUtils.addHasDetails);that.items.forEach(function(item){item.pretty_status_string=collectionUtils.getPrettyStatus(item,that.config);});var versionids=_.map(that.items,function(item){return _.get(item,'versionid');});versionids=_(versionids).pull(null).uniq().value();that.statuses=getStatuses(that.items);_.forEach(versionids,function(versionid){that.versionstatuses[versionid]=getStatuses(_.filter(that.items,{versionid:versionid}));});that.initRatingItem(params);that.findRatingItem();that.loadingItems=false;addStatusWatchers();return response.data;});}else{return $q(function(resolve){resolve();});}};this.setItems=function(items){that.items=items;};var addStatusWatchers=function(){statusWatchers.forEach(function(deregister){deregister();});statusWatchers=[];that.items.forEach(watchStatuses);};var watchStatuses=function(item){var statusWatchCallback=function(newValue,oldValue){if(!angular.equals(newValue,oldValue)&&statusWatchActive){that.updateItem(item,true);}};statusWatchers.push($rootScope.$watchCollection(function(){return item.status;},statusWatchCallback));statusWatchers.push($rootScope.$watch(function(){return item.wishlistpriority;},statusWatchCallback));};this.findRatingItem=function(){if(that.items&&that.items.length>0){that.items.forEach(function(item){if(item.rating>0&&!that.ratingitem.collid){that.ratingitem=item;}});if(!that.ratingitem.collid){that.ratingitem=that.items[0];}}};this.getConfig=function(){that.loadingConfig=true;return collectionHttpTools.getConfig(that.params).then(function(response){that.config=response.data;that.config.currencies=currencies;that.loadingConfig=false;return response;});};}}]);
geekApp.constant('ratingDescriptions',["Awful - defies game description.","Very bad - won’t play ever again.","Bad - likely won’t play this again.","Not so good - but could play again.","Mediocre - take it or leave it.","Ok - will play if in the mood.","Good - usually willing to play.","Very good - enjoy playing and would suggest it.","Excellent - very much enjoy playing.","Outstanding - will always enjoy playing."]);geekApp.directive('addToCollectionButton',['$uibModal',function($modal){var link=function(scope,elem,atrr){var openModal=function(){$modal.open({controller:'GeekCollection_EditorCtrl',controllerAs:'editctrl',confirmOnDismiss:true,windowClass:'modal-fixed-right',templateUrl:'geekitem_dialog_editcollection.tpl',resolve:{additem:function(){return scope.additem;}}});};elem.on('click',openModal);};return{link:link,restrict:'A',scope:{'additem':'='}}}]);geekApp.directive('collectionToolbar',[function(){return{scope:{item:'='},templateUrl:'geekitem_toolbar_collection.tpl',controller:'GeekCollection_ToolbarCtrl',controllerAs:'colltoolbarctrl',restrict:'E',replace:true,bindToController:true};}]);geekApp.directive('miniCollectionToolbar',[function(){return{scope:{item:'='},templateUrl:function(tElement,tAttrs){if(tAttrs.useversions)
return'geekitem_mini_toolbar_collection_versions.tpl';else
return'geekitem_mini_toolbar_collection.tpl';},controller:'GeekCollection_ToolbarCtrl',controllerAs:'colltoolbarctrl',restrict:'E',replace:true,bindToController:true};}]);geekApp.directive('collectionButtonStatusList',[function(){return{restrict:'E',templateUrl:'geekitem_collection_button_statuses.html',scope:{allstatuses:'=',statuses:'=',limit:'=',wrap:'='}}}]);geekApp.directive('collectionRating',[function(){return{scope:{item:'='},templateUrl:function(tElement,tAttrs){if(tAttrs.layout=='mobile')
return'geekitem_collection_rating_mobile.tpl';else
return'geekitem_collection_rating.tpl';},controller:'GeekCollection_ToolbarCtrl',controllerAs:'collratingctrl',restrict:'E',replace:true,bindToController:true};}]);geekApp.directive('collectionPrivateData',['$filter',function($filter){var link=function(scope,element,attrs,ctrl){var pp_value=$filter('currencyFromCode')(scope.item.pricepaid,scope.item.pp_currency);var cv_value=$filter('currencyFromCode')(scope.item.currvalue,scope.item.cv_currency);scope.private_data=[{title:'Price Paid',value:pp_value},{title:'Current Value',value:cv_value},{title:'Quantity',value:scope.item.quantity},{title:'Acquisition Date',value:scope.item.acquisitiondate},{title:'Acquired From',value:scope.item.acquiredfrom},{title:'Comment',value:scope.item.textfield.privatecomment.rendered,trusted:true},{title:'Inv. Date',value:scope.item.invdate},{title:'Inv. Location',value:scope.item.invlocation}];scope.hasPrivateData=function(){return _.some(scope.private_data,function(element){return!!element.value;});};};return{scope:{item:'='},link:link,templateUrl:'geekitem_collection_privatedata.tpl',restrict:'E',replace:true};}]);geekApp.directive('collectionStatusSelector',[function(){return{scope:{item:'=',config:'='},restrict:'E',templateUrl:'geekitem_collection_selector_status.html',replace:true};}]);geekApp.directive('collectionItemName',[function(){return{scope:{item:'='},restrict:'E',templateUrl:'geekitem_collection_item_name.html',replace:true};}]);geekApp.directive('nameWithYear',[function(){return{restrict:'E',scope:{name:'=',year:'='},template:"<span>{{name}}<span ng-hide='(name.indexOf(year) > -1) || year <= 0 || !year'> ({{year}})</span></span>"}}]);geekApp.directive('removeCollectionItem',['prompt','notify','collectionHttpTools',function(prompt,notify,collectionHttpTools){var link=function(scope,elem,atrr){var openModal=function(){prompt({title:'Delete this Item?',message:`
     Are you sure you want to delete the rating and comment of this item?
     Rating: ${scope.item.rating}     
     Comment: ${scope.item.textfield.comment.value} 
     `}).then(function(){if(scope.item)
collectionHttpTools.deleteItem(scope.item.collid).then(function(){notify("Item moderated");},function errorHandler(resp){notify(resp.data.error)});});};elem.on('click',openModal);};return{link:link,restrict:'A',scope:{'item':'='}}}]);
geekApp.controller('GeekCollection_EditorCtrl',['collectionHttpTools','collectionUtils','collectionDataRepo','$stateParams','$uibModal','$uibModalInstance','notify','loadingTracker','$scope','additem','geekImageSelector','timeZoneService','geekAPIUrls','$http','geekImageSelector','geekItemHttpTools','ratingDescriptions',function(collectionHttpTools,collectionUtils,collectionDataRepo,$stateParams,$modal,$uibModalInstance,notify,loadingTracker,$scope,additem,eekImageSelector,timeZoneService,geekAPIUrls,$http,geekImageSelector,geekItemHttpTools,ratingDescriptions){this.$onInit=function(){this.data={};this.showvars={initialized:false,loading:false,recordScreen:'main',versionsPage:1,versionShowcount:10};this.versions=[];this.showStars=false;this.ratingDescriptions=ratingDescriptions;this.errorinfo={};this.modal=$uibModalInstance;this.editdata={item:null,config:null,versions:[]};this.editdata.unchangedItem={};this.initItem();this.initScopeWatchers();this.modal.setBypassConfirmCallback(dataIsUnchanged);};this.setRecordScreen=function(screenname){if(screenname==='versions')
this.getVersions();this.showvars.recordScreen=screenname;};this.getVersions=function(){var that=this;var params={objecttype:this.editdata.item.objecttype,objectid:this.editdata.item.objectid,pageid:this.showvars.versionPage,nosession:1,showcount:this.showvars.versionShowcount,linkdata_index:this.editdata.config.versionlinktype,subtype:this.editdata.config.versionsubtype,sort:this.editdata.config.versionsort};$http.get(geekAPIUrls.linkeditems,{params:params}).then(function(response){that.editdata.versions=response.data;});};this.initCollection=function(params){this.collection=collectionDataRepo.getCollectionData(params);return this.collection.getItems(params);};this.initScopeWatchers=function(){var that=this;$scope.$on('versionSelectorClosed',function(){that.showvars.selectingVersion=false;});$scope.$watch(function(){return _.get(that,'editdata.item.rating');},function(val,old){if(typeof val==='string'&&!isNaN(val)&&Math.floor(val)!=val)
that.editdata.item.rating=parseFloat(val);});};this.initItemFromCollid=function(collid){var that=this;this.showvars.loading=true;this.getItem(collid).then(function(response){var params={objecttype:response.data.item.objecttype,objectid:response.data.item.objectid};if(additem&&additem.rating)
that.editdata.item.rating=additem.rating;that.initConfig(params).then(function(){that.initCollection(params).then(function(){that.showvars.loading=false;that.showvars.initialized=true;});});});};this.initNewItem=function(){var that=this;var params={objecttype:additem.objecttype,objectid:additem.objectid};this.editdata.item={collid:0,pp_currency:'USD',cv_currency:'USD',objecttype:params.objecttype,objectid:params.objectid,status:{},objectname:''};var versionid=additem.versionid?additem.versionid:$stateParams.versionid;if(versionid){this.editdata.item.versionid=versionid;}
var configPromise=this.initConfig(params).then(function(response){that.editdata.item.objectname=response.data.objectname;that.editdata.unchangedItem.objectname=response.data.objectname;return response;});if(additem.status){this.editdata.item.status[additem.status]=true;}
else
if($stateParams.status)
this.editdata.item.status[$stateParams.status]=true;if(additem.rating){this.editdata.item.rating=additem.rating;}
if(versionid){var version_params={objecttype:'version',objectid:versionid,nolinks:true,nodynamic:true};geekItemHttpTools.getItem(version_params).then(function(response){that.updateVersion(response.data.item);_.merge(that.editdata.unchangedItem,that.editdata.item);});}
else{_.merge(that.editdata.unchangedItem,that.editdata.item);}
this.initCollection(params).then(function(){that.showvars.initialized=true;});};this.initItem=function(){if(additem.collid>0){this.initItemFromCollid(additem.collid);}
else{if($stateParams.collid>0){this.initItemFromCollid($stateParams.collid);}
else{this.initNewItem();}}};this.initConfig=function(params){var that=this;this.collection=collectionDataRepo.getCollectionData(params);return this.collection.getConfig().then(function(response){that.editdata.config=response.data;return response;});};this.removeVersion=function(){this.editdata.item.version=null;this.editdata.item.versionid=null;};this.updateVersion=function(version){this.editdata.item.version=version;this.editdata.item.versionid=version.objectid;this.editdata.item.images=version.images;};var dataIsUnchanged=function(){return angular.equals(this.editdata.item,this.editdata.unchangedItem);};this.alwaysShowStars=function(){return!this.editdata.item||this.editdata.item.rating||!this.collection.ratingitem||!this.collection.ratingitem.collid||this.collection.ratingitem.collid==this.editdata.item.collid||!this.collection.ratingitem.rating;};this.save=function(){this.saveItem();$uibModalInstance.close();};this.getItem=function(collid){var that=this;this.showvars.loading=true;var getItemPromise=collectionHttpTools.getItem(collid);loadingTracker.addPromise(getItemPromise);getItemPromise.then(function(response){that.editdata.item=response.data.item;if(!that.editdata.item.pp_currency&&!that.editdata.item.pricepaid)
that.editdata.item.pp_currency='USD';if(!that.editdata.item.cv_currency&&!that.editdata.item.currvalue)
that.editdata.item.cv_currency='USD';if($stateParams.status){if(!that.editdata.item.status)
that.editdata.item.status={};that.editdata.item.status[$stateParams.status]=true;}
that.editdata.item.acquisitiondateobj=dateToObj(that.editdata.item.acquisitiondate);that.editdata.item.invdateobj=dateToObj(that.editdata.item.invdate);that.editdata.unchangedItem=angular.copy(that.editdata.item);that.showvars.showAdvanced=collectionUtils.hasAdvanced(that.editdata.item);that.showvars.loading=false;return response;},function(response){that.showvars.loading=false;that.errorinfo.error=response.data.error;return response;});return getItemPromise;};var dateToObj=function(date){var m=moment.tz(date,timeZoneService.timezone);return m.isValid()?m.toDate():null;};var dateObjToISODate=function(dateObj){if(!dateObj)
return null;return moment(dateObj).format('YYYY-MM-DD');};this.deleteItem=function(item){var that=this;var mi=$modal.open({templateUrl:'geekitem_dialog_deletecollectionitem.tpl',controller:'GeekCollection_DeleteItemCtrl',resolve:{'item':function(){return item;}}});mi.result.then(function(){var params={objecttype:item.objecttype,objectid:item.objectid};collectionHttpTools.deleteItem(item.collid).then(function(response){$uibModalInstance.close();that.forceReloadItems(params);return response;});});};this.saveItem=function(){this.saving=true;this.editdata.item.acquisitiondate=dateObjToISODate(this.editdata.item.acquisitiondateobj);this.editdata.item.invdate=dateObjToISODate(this.editdata.item.invdateobj);var params={objecttype:this.editdata.item.objecttype,objectid:this.editdata.item.objectid};var that=this;if(this.editdata.item.collid){collectionHttpTools.updateItem(this.editdata.item).then(function(response){notify('Item updated');that.forceReloadItems(params);return response;});}else{collectionHttpTools.createItem(this.editdata.item).then(function(response){notify({messageTemplate:'<span>Item added to <a ui-sref="geekitem.mygames">Collection</a></span>'});that.forceReloadItems(params);return response;});}};this.statusIsEmpty=function(){if(!_.has(this.collection,'config.allstatuses')||!_.has(this.collection,'item.status'))
return false;if(!_.isObject(this.editdata.item.status)){return true;}
var that=this;return!_.some(this.collection.config.allstatuses,function(status){return that.editdata.item.status[status.key];});};this.forceReloadItems=function(params){this.collection=collectionDataRepo.getCollectionData(params);if(this.collection)
this.collection.getItems(params,true);};this.openDatePicker=function($event,type){$event.preventDefault();$event.stopPropagation();this[type]=true;};this.selectImage=function(objecttype,objectid){var options={objecttype:objecttype,objectid:objectid};var that=this;geekImageSelector(options).then(function(image){that.editdata.item.imageid=image.imageid;},function(error){});};}]);
geekApp.factory('collectionHttpTools',['$http','loadingTracker','$httpParamSerializerJQLike','$q','geekAPIUrls',function($http,loadingTracker,$httpParamSerializerJQLike,$q,geekAPIUrls){var collectionTools={};collectionTools.itemNamespace=1;collectionTools.createItem=function(item){return loadingTracker.addPromise($http.post('/api/collectionitems',{'item':item}));};var updatePromise=$q(function(resolve){return resolve();});collectionTools.updateItem=function(item){updatePromise=updatePromise.then(function(){return _updateItem(item);});return updatePromise;};var _updateItem=function(item){return loadingTracker.addPromise($http.put('/api/collectionitems/'+item.collid,{'item':item}));};collectionTools.deleteItem=function(collid){return loadingTracker.addPromise($http.delete('/api/collectionitems/'+collid));};collectionTools.getItem=function(collid){return loadingTracker.addPromise($http.get('/api/collectionitems/'+collid));};collectionTools.getVersions=_.memoize(function(params){var url='/api/collections/versions';return loadingTracker.addPromise($http.get(url,{params:params}));},function(params){return'getVersions_'+params.objecttype+'_'+params.objectid;});collectionTools.getConfig=_.memoize(function(paramsIn){var params=angular.copy(paramsIn);var url=geekAPIUrls.collections;params.action='getconfig';params.nosession=1;return loadingTracker.addPromise($http.get(url,{params:params}));},function(params){return'getConfigData'+params.objecttype+'_'+params.objectid;});collectionTools.clearCache=function(){collectionTools.itemNamespace++;};collectionTools.getItems=_.memoize(function(params){var url;if(params.userid){url='/api/collections';}else{url=geekAPIUrls.collections;}
return loadingTracker.addPromise($http.get(url,{params:params,paramSerializer:'$httpParamSerializerJQLike'}));},function(params){var key='getItems_'+params.objecttype+'_'+params.objectid+'_'+params.userid+'_'+params.pageid;if(params.status)
key+=JSON.stringify(params.status);key+=collectionTools.itemNamespace;return key;});collectionTools.getItemStatuses=function(items,userid){var url='/api/collectionstatuses';var params={items:items,userid:userid};$http.get(url,{params:params,paramSerializer:'$httpParamSerializerJQLike'});};return collectionTools;}]);
geekApp.controller('GeekCollection_ModuleCtrl',['collectionDataRepo','collectionHttpTools','$state','geekitemParams','geekitem','geekitemSettings',function(collectionDataRepo,collectionHttpTools,$state,geekitemParams,geekitem,geekitemSettings){var that=this;this.firstload=false;this.$onInit=function(){this.geekitem=new geekitem(geekitemParams);this.geekitem.getItem();this.params=angular.copy(this.item);this.collection=collectionDataRepo.getCollectionData(this.params);that.collection.getConfig().then(function(){that.getItems();});this.geekitemSettings=geekitemSettings;};this.getItems=function(force){that.loading=true;that.collection.getItems(that.params,force).then(function(response){that.loading=false;that.firstload=true;return response;});};this.editCollection=function(collid){var route='geekitem.collection.edit';var params={'collid':collid};$state.go(route,params);};}]);
geekApp.factory('collectionDataRepo',['collectionData',function(collectionData){var dataRepo={};dataRepo.collectionDataCache=[];dataRepo.getCollectionData=function(params){var key=params.objecttype+'_'+params.objectid;if(dataRepo.collectionDataCache[key]){return dataRepo.collectionDataCache[key];}
else{dataRepo.collectionDataCache[key]=new collectionData(params);return dataRepo.collectionDataCache[key];}};return dataRepo;}]);
geekApp.controller('GeekCollection_ToolbarCtrl',['collectionDataRepo','collectionHttpTools','$state','geekScroller','$location','$timeout','$uibModal','notify','ratingDescriptions',function(collectionDataRepo,collectionHttpTools,$state,geekScroller,$location,$timeout,$modal,notify,ratingDescriptions){var that=this;this.ratingDescriptions=ratingDescriptions;this.$onInit=function(){that.params=angular.copy(that.item);this.collection=collectionDataRepo.getCollectionData(that.params);this.getItems();};this.clearRating=function(item){if(item.collid){item.rating=0;collectionHttpTools.updateItem(item).then(function(){notify("Rating cleared");that.getItems();});}};this.editItemRating=function(collid){var additem={collid:that.collection.ratingitem.collid,rating:that.collection.ratingitem.rating,objecttype:that.collection.ratingitem.objecttype,objectid:that.collection.ratingitem.objectid};return this.editItem(additem);};this.editItem=function(additem){var mi=$modal.open({controller:'GeekCollection_EditorCtrl',controllerAs:'editctrl',confirmOnDismiss:true,windowClass:'modal-fixed-right',templateUrl:'geekitem_dialog_editcollection.tpl',resolve:{additem:function(){return additem;}}});mi.result.then(function(){},function(){that.getItems(true)});};this.goToMyGames=function(){if($state.includes('geekitem.mygames.collection')){geekScroller.scrollToTargetByName('mygames');if(!$state.includes('geekitem.mygames.collection',{'#':'mygames'})){$timeout(function(){$location.hash('mygames');},500);}}
else{$state.go('geekitem.mygames.collection',{'#':'mygames'});}};this.hasVersion=function(){return _.some(that.collection.items,{versionid:that.item.versionid});};this.getItems=function(force){that.loading=true;that.collection.getConfig(that.params).then(function(){that.collection.getItems(that.params,force).then(function(){that.loading=false;});});};}]);
geekApp.factory('collectionUtils',[function(){var utils={};utils.hasAdvanced=function(item){var advancedFields=['pricepaid','currvalue','acquisitiondate','invdate','quantity','acquiredfrom','privatecomment','invlocation','textfield.conditiontext.value','textfield.haspartslist.value','textfield.wantpartslist.value','textfield.wishlistcomment.value','imageid','publisherid','languageid','year','other','barcode'];return utils.hasSomeFields(item,advancedFields);};utils.addHasDetails=function(item){item.hasDetails=utils.hasDetails(item);return item;};utils.hasDetails=function(item){var detailsFields=['pricepaid','currvalue','acquisitiondate','invdate','quantity','acquiredfrom','privatecomment','invlocation','textfield.conditiontext.value','textfield.haspartslist.value','textfield.wantpartslist.value','textfield.wishlistcomment.value'];return utils.hasSomeFields(item,detailsFields);};utils.hasSomeFields=function(item,fields){var checker=_.ary(_.curry(_.get,2)(item),1);return _.some(fields,checker);};utils.getPrettyStatus=function(item,config){if(!item.status)
return'';var sortedstatuses=config.allstatuses.sort(function(a,b){return a.priority-b.priority});return _.reduce(sortedstatuses,function(acc,status){if(item.status[status.key])
acc.push(status.name);return acc;},[]).join(", ");};return utils;}]);
