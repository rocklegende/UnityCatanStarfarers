geekApp.service('geekitemParams',['$location',function($location){var re=/\/([a-z]+)\/(\d+)/;var matches=re.exec($location.absUrl());var objecttype='';var subtype=matches[1];var objectid=matches[2];switch(subtype){case'boardgame':case'boardgameexpansion':case'boardgameaccessory':objecttype='thing';break;case'boardgamedesigner':case'boardgameartist':objecttype='person';break;case'boardgamepublisher':objecttype='company';break;case'boardgamemechanic':case'boardgamecategory':objecttype='property';break;case'boardgamefamily':objecttype='family';break;}
return{subtype:subtype,objecttype:objecttype,objectid:objectid};}]);geekApp.factory('geekitem',['$location','$http','geekItemHttpTools','loadingTracker','geekitemPreload','$q',function($location,$http,geekItemHttpTools,loadingTracker,geekitemPreload,$q){return function(params){var that=this;this.geekitem={loaded:false,subtype:params.subtype,objecttype:params.objecttype,objectid:params.objectid};this.overrideRectAd=false;this.clearCache=function(){geekItemHttpTools.clearCache();};this.fixupCommerceLinks=function(){var isValidLink=function(commercelink){if(commercelink.ordertype!=='crowdox_preorder'){return true;}
if(!commercelink.orderstartdate||!commercelink.orderenddate){return false;}
return moment().isBetween(moment(commercelink.orderstartdate),moment(commercelink.orderenddate),'day',"[]");}
if(!that.data.item.commercelinks){return;}
that.data.item.commercelinks=that.data.item.commercelinks.filter(isValidLink);for(var i=0;i<this.data.item.commercelinks.length;i++){if(that.data.item.commercelinks[i].rect_ad_url){that.overrideRectAd=that.data.item.commercelinks[i];}
if(that.data.item.commercelinks[i].ordertype==='crowdox_preorder'){that.buyButtonType="preorder";}}};this.getItem=function(bypass_preload){if(!bypass_preload&&geekitemPreload&&this.geekitem.objecttype==geekitemPreload.item.objecttype&&this.geekitem.objectid==geekitemPreload.item.objectid){that.data=geekitemPreload;that.fixupCommerceLinks();that.loaded=true;that.geekitem.loaded=true;var response={data:geekitemPreload};return $q.resolve(response);}
return loadingTracker.addPromise(geekItemHttpTools.getItem(params).then(function(response){that.data=response.data;that.fixupCommerceLinks();that.loaded=true;that.geekitem.loaded=true;return response;}));};}}]);geekApp.controller('GeekDropdownCtrl',[function(){this.onToggle=function(open){if(open){el=document.getElementById('dropdowntarget');el.focus();}}}]);geekApp.controller('GeekItemCtrl',['geekitem','geekitemParams','$uibModal','$scope','$state','$location','geekAccount','geekAdmin','geekitemTabs','geekitemSettings','$window',function(geekitem,geekitemParams,$modal,$scope,$state,$location,geekAccount,geekAdmin,geekitemTabs,geekitemSettings,$window){var that=this;that.geekitemSettings=geekitemSettings;this.preorderAction=Math.random()>0.5?'Back':'Visit';this.logClick=function(category,action,label,href){$window.ga('send','event',category,action,label);$window.location.href=href;};this.logEvent=function(category,action){action=action==='backproject'?action+":"+this.preorderAction:action;$window.ga('send','event',category,action,this.geekitem.data.item.name);};this.initAdminTab=function(){geekAccount.admin.then(function(admin){if(admin.any){geekAdmin.checkAccess(['itemmgr','admgr','seemenus'],geekitemParams.objecttype,geekitemParams.objectid).then(function(status){if(status.itemmgr){var edit_tab={heading:'Admin Edit',route:'geekitem.edit',menuType:'game',type:'menu'};that.tabData.push(edit_tab);that.showadminnotes=true;}
if(status.admgr||status.seemenus)
that.editamazon=true;});}});};this.geekitemParams=geekitemParams;var params=angular.copy(geekitemParams);params.linkshowcount=this.linkshowcount;this.geekitem=new geekitem(params);this.state=$state;this.hash=$location.hash();this.showcounts={forums:{comfortable:50,compact:100},files:{comfortable:25,compact:50},videos:{comfortable:36,compact:50}};switch(params.subtype){case'boardgame':case'boardgameexpansion':case'boardgameaccessory':this.tabData=geekitemTabs.boardgame;break;case'boardgamedesigner':case'boardgameartist':case'boardgamepublisher':this.tabData=geekitemTabs.boardgamegeneric;break;case'boardgamemechanic':case'boardgamecategory':case'boardgamefamily':this.tabData=geekitemTabs.boardgamegeneric;break;}
this.geekitem.getItem();this.initAdminTab();}]);geekApp.controller('GeekItem_MediaCtrl',['moduleLoader','geekAPIUrls','geekitemParams',function(moduleLoader,geekAPIUrls,geekitemParams){var that=this;this.url=geekAPIUrls.images;this.params={showcount:17,size:'crop100',sort:'hot','galleries[]':['game','creative'],objecttype:geekitemParams.objecttype,objectid:geekitemParams.objectid,nosession:1};this.getModule=function(){moduleLoader.getModule(this.url,this.params).then(function(response){that.data=response.data;});};this.getModule();}]);geekApp.controller('GeekItem_HeaderCtrl',['geekitemParams','playHttpTools','$scope','geekScroller',function(geekitemParams,playHttpTools,$scope,geekScroller){var that=this;this.playCountStats={};var refreshPlayCount=function(){playHttpTools.getUserPlayCount(geekitemParams).then(function(result){that.playCountStats=result.data;});};that.scrollToBuy=function(){geekScroller.scrollToTargetByName('buyacopy');};refreshPlayCount();$scope.$on('playsUpdated',function(event,playCountAdjust){that.playCountStats.count+=playCountAdjust;});}]);geekApp.controller('GeekItem_MentionsCtrl',['$state',function($state){this.tabData=[{heading:'Web Links',route:'geekitem.mentions.links'},{heading:'BGG News',route:'geekitem.mentions.news'},{heading:'BGG Blog Posts',route:'geekitem.mentions.blogs'},{heading:'Podcasts',route:'geekitem.mentions.podcasts'}];this.tabData.forEach(function(tab){tab.href=$state.href(tab.route);})}]);geekApp.controller('GeekItem_MyGamesCtrl',[function(){this.tabData=[{heading:'My Collection',route:'geekitem.mygames.collection'},{heading:'My Plays',route:'geekitem.mygames.plays'},{heading:'Tags',route:'geekitem.mygames.tags'}];}]);geekApp.controller('GeekItem_TradeCtrl',[function(){this.tabData=[{heading:'For Trade',route:'geekitem.trading',params:{status:'fortrade'}},{heading:'Want in Trade',route:'geekitem.trading',params:{status:'want'}},{heading:'Has Parts',route:'geekitem.trading',params:{status:'hasparts'}},{heading:'Wants Parts',route:'geekitem.trading',params:{status:'wantparts'}}];}]);geekApp.controller('GeekItem_MarketplaceCtrl',[function(){this.tabData=[{heading:'GeekMarket',route:'geekitem.marketplace.geekmarket'},{heading:'eBay',route:'geekitem.marketplace.ebay'}];}]);geekApp.controller('GeekItem_FullCreditsCtrl',['geekitem','geekitemParams',function(geekitem,geekitemParams){var params=angular.copy(geekitemParams);params.linkshowcount=this.linkshowcount;this.geekitem=new geekitem(params);this.geekitem.getItem(true);}]);geekApp.controller('GeekItem_OverviewSubmoduleCtrl',['geekitemParams',function(geekitemParams){this.geekitemParams=geekitemParams;this.hasCrowdOx=function(){if(!this.geekitem||!this.geekitem.data||!this.geekitem.data.item||!this.geekitem.data.item.commercelinks){return false;}
return _.some(this.geekitem.data.item.commercelinks,function(link){return link.ordertype.indexOf('crowdox')>=0;});}}]);geekApp.controller('GeekItem_GeekUpAdModuleCtrl',['geekitemParams','$window',function(geekitemParams,$window){this.geekitemParams=geekitemParams;this.sendGA=function(eventData){$window.ga('send','event',eventData.eventCategory,eventData.eventAction,eventData.eventLabel,eventData.eventValue);}}]);geekApp.controller('GeekItem_PromotedVideosCtrl',['geekitemParams','$window',function(geekitemParams,$window){this.geekitemParams=geekitemParams;this.sendGA=function(eventData){$window.ga('send','event',eventData.eventCategory,eventData.eventAction,eventData.eventLabel,eventData.eventValue);}}]);geekApp.controller('GeekItem_FlagsModuleCtrl',['geekitemParams',function(geekitemParams){this.geekitemParams=geekitemParams;this.somePositiveRanks=function(rankinfo){return _.some(rankinfo,function(r){return r.rank>0;});};this.$onInit=function(){this.showRanks=this.somePositiveRanks(this.geekitem.data.item.rankinfo);this.showClassifications=!this.geekitem.data.item.linkcounts||this.geekitem.data.item.linkcounts.reimplements||this.geekitem.data.item.linkcounts.expandsboardgame||this.geekitem.data.item.linkcounts.reimplementation;};}]);
geekApp.controller('GeekItem_AwardsCtrl',['moduleLoader','geekitem','geekitemParams','geekAPIUrls','geekitemSettings',function(moduleLoader,geekitem,geekitemParams,geekAPIUrls,geekitemSettings){var that=this;this.geekitemSettings=geekitemSettings;this.honors=[];var params=angular.copy(geekitemParams);params.linkshowcount=this.linkshowcount;var geekitemobj=new geekitem(params);geekitemobj.getItem().then(function(response){if(_.has(response,'data.item.linkcounts.boardgamehonor')&&response.data.item.linkcounts.boardgamehonor>that.linkshowcount){moduleLoader.getModule(geekAPIUrls.linkeditems,{linkdata_index:"boardgamehonor",subtype:"boardgamehonor",objecttype:geekitemParams.objecttype,objectid:geekitemParams.objectid,nosession:1,showcount:50}).then(function(result){that.honors=result.data.items;});}else{that.honors=response.data.item.links.boardgamehonor;}})}]);
geekApp.directive('geekitem',[function(){return{controller:'GeekItemCtrl',controllerAs:'geekitemctrl',bindToController:true,restrict:'E',replace:true,templateUrl:'geekitem_main.tpl',scope:{linkshowcount:'@',subtype:'@'}};}]);geekApp.directive('popupList',[function(){return{templateUrl:function(tElement,tAttrs){if(tAttrs.itemsinline)
return'popupListInline.html';else
return'popupList.html';},restrict:'E',link:function(scope){var deregister=scope.$watch('loaded',function(loaded){if(loaded){deregister();if(scope.items&&scope.items.length>0&&scope.items[0].primarylink){scope.listshowcount=0;var index=0;do{scope.listshowcount+=1;index+=1;}while(!!scope.items[index]&&scope.items[index].primarylink);}else{scope.listshowcount=scope.showcount>0?Math.min(+scope.showcount,scope.items.length):1;if((1+ +scope.listshowcount)===+scope.numitems&&+scope.numitems===scope.items.length){scope.listshowcount=1+ +scope.listshowcount;}}
scope.delta=scope.numitems-scope.listshowcount;scope.showmore=scope.numitems>scope.listshowcount;}})},scope:{items:'=',sref:'@',action:'=',itemsinline:'@',showcount:'@',characters:'@',numitems:'=',loaded:'='}};}]);geekApp.directive('truncatedList',[function(){var link=function(scope){scope.expanded=false;scope.trunc=function(value,index){if(scope.expanded){return true;}else{return index===0;}};};return{templateUrl:'truncatedList.html',restrict:'E',link:link,scope:{'items':'='}};}]);geekApp.directive('pagedCountRange',[function(){return{templateUrl:'rangetemplate.html',restrict:'E',link:function(scope){var calculateRange=function(){var pageid=scope.pageid||1;scope.min=Math.min((pageid-1)*scope.showcount+1,scope.numitems);scope.max=Math.min(pageid*scope.showcount,scope.numitems);};calculateRange();scope.sep='‐';scope.$watchGroup(['pageid','numitems','showcount'],function(){calculateRange();});},replace:true,scope:{'showcount':'=','pageid':'=','numitems':'='}}}]);geekApp.directive('sortOptions',function(){return{scope:{sort:'&',params:'='},templateUrl:'geekitem_directive_sortoptions.tpl'}});geekApp.directive('itemSortDropdown',[function(){return{scope:{sortdata:'=',sort:'=',setParam:'='},replace:true,templateUrl:'itemSortDropdown.html'};}]);geekApp.directive('itemFilterDropdown',[function(){return{scope:{filter:'=',value:'=',setParam:'=',clearParam:'='},replace:true,templateUrl:'itemFilterDropdown.html'};}]);geekApp.directive('kickstarterWidget',['geekitem',function(geekitem){return{scope:{'url':'='},templateUrl:'geekitem_widget_kickstarter.tpl',restrict:'E'};}]);geekApp.directive('shopifyWidget',['geekitem',function(geekitem){return{scope:{showthumbnail:'@',shopifyitem:'='},templateUrl:'geekitem_widget_shopify.tpl',restrict:'E'};}]);geekApp.directive('mediaGridInfo',['$state','geekAPIUrls','geekitemPreload',function($state,geekAPIUrls,geekitemPreload){function PreloadData(ctrl,data){ctrl.data=data;ctrl.firstload=true;ctrl.loaded=true;}
var link=function(scope,element,attrs,ctrl){ctrl.params={nosession:1};ctrl.disablelocation=true;switch(ctrl.mediatype){case'image':ctrl.title={singular:'Image',plural:'Images'};ctrl.url=geekAPIUrls.images+'/summary';ctrl.route='geekitem.images';ctrl.href=$state.href(ctrl.route);ctrl.additem_template='add_image.tpl';if(geekitemPreload)
PreloadData(ctrl,geekitemPreload.media.images);break;case'video':ctrl.title={singular:'Video',plural:'Videos'};ctrl.url=geekAPIUrls.videos+'/summary';ctrl.route='geekitem.videos';ctrl.href=$state.href(ctrl.route);ctrl.additem_template='add_video.tpl';if(geekitemPreload)
PreloadData(ctrl,geekitemPreload.media.videos);break;case'file':ctrl.title={singular:'File',plural:'Files'};ctrl.url=geekAPIUrls.files+'/summary';ctrl.route='geekitem.files';ctrl.href=$state.href(ctrl.route);ctrl.additem_template='add_file.tpl';if(geekitemPreload)
PreloadData(ctrl,geekitemPreload.media.files);break;}
if(!geekitemPreload)
ctrl.getModule();};return{scope:{mediatype:'@'},link:link,templateUrl:'geekitem_media_grid_cell.tpl',controller:'GeekItem_ModuleCtrl',controllerAs:'mediactrl',restrict:'E',replace:true,bindToController:true};}]);geekApp.directive('activateUiSelectOnCreate',['$timeout',function($timeout){return{require:'uiSelect',restrict:'A',link:function(scope,elem,attrs,ctrl){if(attrs.activateUiSelectOnCreate=='true'){$timeout(ctrl.activate,0);}}};}]);geekApp.directive('emitOnClose',[function(){return{require:'uiSelect',restrict:'A',link:function(scope,elem,attrs){scope.$on('uis:close',function(){scope.$emit(attrs.emitOnClose);});}};}]);geekApp.directive('gkExpandableGeekitem',['geekitemSettings',function(geekitemSettings){var link=function(scope,element,attrs,ctrl){if(geekitemSettings.fulldescriptions)
ctrl.expanded=true;};return{restrict:'A',scope:{'maxHeight':'@expandableHeight','id':'@gkExpandable'},transclude:true,templateUrl:'geekExpandable.html',controller:'GeekExpandableController',controllerAs:'expandablectrl',bindToController:true,link:link}}]);geekApp.directive('noAnimate',['$animate',function($animate){return{restrict:'A',link:function(scope,elem){$animate.enabled(elem,false);}};}]);geekApp.directive('scrollTopOnEnter',['$animate',function($animate){return{restrict:'A',link:function(scope,element,attrs){var scrollIntoViewOnClose=function(el,phase){if(phase==='close'){element[0].scrollIntoView(true);$animate.off('enter',element,scrollIntoViewOnClose);}};$animate.on('enter',element,scrollIntoViewOnClose);}};}]);geekApp.factory('rememberScrollData',function(){var data={'positions':{}};return data;});geekApp.directive('rememberParentScroll',['rememberScrollData','$timeout','$animate',function(rememberScrollData,$timeout,$animate){return{restrict:'A',link:function(scope,element,attrs){var id=attrs.rememberParentScroll;if(!id)
return;var scrollToPositionOnAnimationClose=function(el,phase){if(phase==='close'&&rememberScrollData.positions[id]){var position=rememberScrollData.positions[id];$timeout(function(){position.scrollEl.scrollTop=position.scrollTop;$animate.off('enter',element,scrollToPositionOnAnimationClose);},50);}};$animate.on('enter',element,scrollToPositionOnAnimationClose);var findFirstScrolledParent=function(el){while(el=el.parentElement){if(el.scrollTop)
return el;}};$animate.on('leave',element,function(el,phase){if(phase==='start'){var scrollEl=findFirstScrolledParent(element[0]);rememberScrollData.positions[id]={scrollEl:scrollEl,scrollTop:scrollEl.scrollTop};}});}}}]);geekApp.directive('starGuidelines',function(){return{restrict:'E',scope:{overstar:'=',rating:'=ratingvalue'},templateUrl:"star_guidelines.tpl"};});geekApp.directive('geekStickyColumn',['geekHeaders','loadingTracker',function(geekHeaders,loadingTracker){return{restrict:'A',link:function(scope,element){if(navigator.userAgent.match(/Android|BlackBerry|iPhone|iPad|iPod|Opera Mini|IEMobile/i))
return;var unstick=false;var offset=geekHeaders.getHeight();var addStickyColumn=function(){if(!unstick){return $(element).stick_in_parent({recalc_every:10,offset_top:offset});}};loadingTracker.onLoad(addStickyColumn);scope.$watch('unstickOn',function(value){if(value){unstick=true;$(element).trigger("sticky_kit:detach");}});},scope:{unstickOn:'='}};}]);geekApp.directive('addLinkedItemLink',['geekitem',function(geekitem){return{restrict:'E',link:function(scope){var params=angular.copy(scope.baseItemParams);params.linkshowcount=5;var geekitemobj=new geekitem(params);var setHref=function(){geekitemobj.getItem().then(function(response){var linkdata=_.find(response.data.item.itemdata,{keyname:scope.linkIndex});if(_.get(linkdata,'addnew')){scope.href='/item/create/'+linkdata.other_subtype+'?src_objecttype='+params.objecttype+'&src_objectid='+params.objectid;}else{scope.href='/item/correction/'+params.subtype+'/'+params.objectid;}});};var listener=scope.$watch('linkIndex',function(value){if(value){listener();setHref();}});},scope:{baseItemParams:'=',linkIndex:'='},replace:true,transclude:true,template:"<a ng-href='{{href}}' ng-transclude></a>"}}]);geekApp.directive('geekDimensions',function(){return{restrict:'E',link:function(scope){var fielddata=_.find(scope.itemdata,{keyname:scope.fieldname});var dimensions=_.find(fielddata.options,function(option){return _.reduce(_.pick(option,fielddata.savefields),function(acc,value,key){return!acc?acc:(Math.abs(value-scope.item[key])<0.1);},true);});if(dimensions){scope.dimensionsTitle=dimensions.title;}},scope:{item:'=',fieldname:'@',itemdata:'='},templateUrl:"geekDimensions.html"}});geekApp.directive('showWeightGraph',['$uibModal','geekitemParams','$http',function($modal,geekitemParams,$http){var link=function(scope,elem){elem.on('click',function(){var url='/collection/weightgraph/'+geekitemParams.objecttype+'/'+geekitemParams.objectid;$http.get(url,{params:{ajax:1,imgonly:true}}).then(function(response){$modal.open({'scope':scope,'template':response.data});});});};return{link:link,restrict:'A',scope:{}}}]);geekApp.directive('showingRange',[function(){return{restrict:'E',scope:{numitems:'=',showcount:'=',pageid:'=',firstload:'='},replace:true,templateUrl:'showingRange.html'};}]);geekApp.directive('autofocus',['$timeout',function($timeout){return{restrict:'A',link:function($scope,$element){$timeout(function(){$element[0].focus();});}}}]);geekApp.directive('avatarMd',[function(){return{restrict:'E',scope:{user:'='},replace:true,templateUrl:'avatar_md.html'};}]);geekApp.directive('unboundedPagination',[function(){return{scope:{itemsPerPage:'=',itemsOnPage:'='},controller:'unboundedPaginationCtrl',controllerAs:'paginationctrl',require:['unboundedPagination','?ngModel'],templateUrl:'geekitem_pagination_unbounded.html',link:function(scope,el,attrs,ctrls){var paginationCtrl=ctrls[0];var modelCtrl=ctrls[1];paginationCtrl.init(modelCtrl);}};}]);geekApp.directive('showcountSelector',[function(){return{scope:{showcount:'=',options:'=',setter:'='},templateUrl:'geekitem_showcount_selector.html'};}]);geekApp.controller('unboundedPaginationCtrl',['$scope',function($scope){var that=this;this.init=function(modelCtrl){that.modelCtrl=modelCtrl;modelCtrl.$render=function(){$scope.page=parseInt(that.modelCtrl.$viewValue,10)||1;};$scope.onLastPage=$scope.itemsPerPage<$scope.itemsOnPage;};$scope.selectPage=function(page){if(page<1||((page>$scope.page)&&$scope.onLastPage))
return;that.modelCtrl.$setViewValue(page);that.modelCtrl.$render();};}]);geekApp.directive('editGeekItemSettings',['$uibModal','geekitemSettings','geekitemModules',function($modal,geekitemSettings,geekitemModules){var link=function(scope,elem,atrr){var openModal=function(){$modal.open({controller:'GeekItem_EditSettingsCtrl',controllerAs:'editsettingsctrl',templateUrl:'geekitem_dialog_editgeekitemsettings.tpl',resolve:{settings:function(){return geekitemSettings;},modules:function(){return geekitemModules;}}});};elem.on('click',openModal);};return{link:link,restrict:'A'}}]);
geekApp.directive('ebayOverviewModule',['geekAPIUrls',function(geekAPIUrls){var link=function(scope,element,attrs,ctrl){ctrl.disablelocation=true;ctrl.url=geekAPIUrls+'/items';ctrl.params={showcount:ctrl.showcount,sort:'fixed'};ctrl.getModule();};return{scope:{showcount:'@',sort:'@'},controller:'GeekItem_ModuleCtrl',controllerAs:'ebayctrl',link:link,bindToController:true,templateUrl:'geekitem_module_ebay_overview.tpl'}}]);geekApp.directive('ebayModule',['geekAPIUrls',function(geekAPIUrls){var link=function(scope,element,attrs,ctrl){ctrl.url=geekAPIUrls.geekbay+'/items';ctrl.params={showcount:ctrl.showcount,sort:ctrl.sort};var isLastDay=function(endtime){if(endtime===null)
return endtime;var m=moment.tz(endtime,'America/Chicago');return m.isBefore(moment().add(1,'days'));};scope.isLastDay=_.memoize(isLastDay,function(endtime){return"lastday_"+endtime;});ctrl.config={sortdata:[{title:'Recent',key:'recent'},{title:'Ending',key:'endtime'},{title:'Fixed Price',key:'fixed'}]};ctrl.getModule();};return{scope:{showcount:'@',sort:'@'},controller:'GeekItem_ModuleCtrl',controllerAs:'ebayctrl',link:link,bindToController:true,templateUrl:'geekitem_module_ebay_full.tpl'}}]);geekApp.controller('ebaySummaryCtrl',['$http','geekAPIUrls','geekitemPreload',function($http,geekAPIUrls,geekitemPreload){var that=this;this.$onInit=function(){$http.get(geekAPIUrls.geekbay+'/summary',{params:{objecttype:this.objecttype,objectid:this.objectid,sort:'nosort',nosession:1}}).then(function(response){that.data=response.data;});};}]);geekApp.directive('ebaySummary',[function(){return{restrict:'E',scope:{objecttype:'=',objectid:'='},replace:true,controller:'ebaySummaryCtrl',controllerAs:'ebsctrl',templateUrl:'ebay_item_summary.tpl',bindToController:true}}]);
geekApp.directive('geekitemedit',function(){return{restrict:'A',controller:'GeekItem_EditCtrl',controllerAs:'geekitemeditctrl',bindToController:{skipupdate:'='}}});geekApp.controller('GeekItem_EditCtrl',['geekitem','geekitemParams','$http','$q','$scope','notify',function(geekitem,geekitemParamsShared,$http,$q,$scope,notify){notify.config({duration:3000});var that=this;var geekitemParams=angular.copy(geekitemParamsShared);geekitemParams.includePending=true;geekitemParams.useSession=true;geekitemParams.edit=true;this.geekitem=new geekitem(geekitemParams);this.geekitemParams=geekitemParams;this.viewVars={searchLoading:false};var combineNames=function(){that.geekitem.data.item.allnames=_.map(that.geekitem.data.item.alternatenames,_.clone);if(that.geekitem.data.item.primaryname)
that.geekitem.data.item.allnames.unshift(that.geekitem.data.item.primaryname);};var updateItem=function(nocache){if(nocache)
that.geekitem.clearCache();return that.geekitem.getItem(true).then(combineNames);};var notifyResponseMessage=function(response){notify(response.data.message);};var updateItemThenNotifyResponse=function(response){updateItem(true).then(function(){notify(response.data.message);});};this.addName=function(){that.inserted_name={name:'',nameid:null,sortindex:1};that.geekitem.data.item.allnames.push(that.inserted_name);that.geekitem.data.item.alternatenames.push(that.inserted_name);};this.invalidateCache=function(){var url='/api/geekitems/'+that.geekitemParams.objecttype+'/'+that.geekitemParams.objectid+'/invalidatecache';$http.post(url).then(updateItemThenNotifyResponse);};this.subtypeUnremovable=function(subtype){if(!this.geekitem.loaded)
return false;if(this.geekitem.data.item.subtypes.length<=1)
return true;return _.some(this.geekitem.data.item.links,function(links){return _.some(links,{linktype:subtype,direction:'dst'});});};this.removeName=function(name,repeatScope){var url='/api/geekitems/'+that.geekitemParams.objecttype+'/'+that.geekitemParams.objectid+'/names/'+name.nameid;repeatScope.updating=true;return $http.delete(url).then(function(response){updateItem(true).then(function(){repeatScope.updating=false;notify(response.data.message);});},notifyResponseMessage);};this.saveName=function(name){var promise=null;var url='/api/geekitems/'+that.geekitemParams.objecttype+'/'+that.geekitemParams.objectid+'/names';var data={name:name.name,sortindex:name.sortindex};if(name.nameid){url+='/'+name.nameid;promise=$http.put(url,data).then(updateItemThenNotifyResponse,notifyResponseMessage);}else{promise=$http.post(url,data).then(updateItemThenNotifyResponse,notifyResponseMessage);}
return promise;};this.setPrimaryName=function(name,repeatScope){var url='/api/geekitems/'+that.geekitemParams.objecttype+'/'+that.geekitemParams.objectid;var data={primarynameid:name.nameid};repeatScope.updating=true;return $http.patch(url,data).then(function(response){updateItem(true).then(function(){repeatScope.updating=false;notify(response.data.message);})},function(response){repeatScope.updating=false;notify(response.data.message);});};this.saveField=function(fieldname,value){var url='/api/geekitems/'+that.geekitemParams.objecttype+'/'+that.geekitemParams.objectid;var data={fieldname:fieldname,value:value};return $http.patch(url,data).then(updateItemThenNotifyResponse,notifyResponseMessage);};this.showAllItems=function(linkdata){var url='/api/geekitems';var params={search:'',lookup_subtype:linkdata.lookup_subtype,objecttype:linkdata.lookup_subtype};$http.get(url,{params:params}).then(function(response){linkdata.items=response.data.items;});};var searchItemsCanceller=null;this.searchItems=function(search,lookup_subtype,other_objecttype){var url='/api/geekitems';that.viewVars.searchLoading=true;if(searchItemsCanceller){searchItemsCanceller.resolve();}
searchItemsCanceller=$q.defer();var params={objecttype:lookup_subtype?lookup_subtype:other_objecttype,lookup_subtype:lookup_subtype,search:search};return $http.get(url,{params:params,timeout:searchItemsCanceller.promise}).then(function(response){that.viewVars.searchLoading=false;if(response.data.items.length)
return response.data.items;else
return[{name:'None found','objectid':0}];});};this.linkItem=function($item,linkdata){var url='/api/geekitems/'+that.geekitemParams.objecttype+'/'+that.geekitemParams.objectid;var data=null;if(linkdata.self_prefix=='src'){data={src_objecttype:that.geekitemParams.objecttype,src_objectid:that.geekitemParams.objectid,dst_objecttype:$item.objecttype,dst_objectid:$item.objectid,linktype:linkdata.linktype,action:'addlink'}}else{data={src_objecttype:$item.objecttype,src_objectid:$item.objectid,dst_objecttype:that.geekitemParams.objecttype,dst_objectid:that.geekitemParams.objectid,linktype:linkdata.linktype,action:'addlink'}}
return $http.patch(url,data).then(updateItemThenNotifyResponse,notifyResponseMessage);};this.removeLink=function(link,repeatScope){var url='/api/geekitems/'+that.geekitemParams.objecttype+'/'+that.geekitemParams.objectid+'/links/'+link.linkid;repeatScope.updating=true;return $http.delete(url).then(function(response){repeatScope.saving=false;updateItem(true).then(function(){repeatScope.updating=false;notify(response.data.message);});},notifyResponseMessage);};this.setPrimaryLink=function(link,primarylink,repeatScope){var url='/api/geekitems/'+that.geekitemParams.objecttype+'/'+that.geekitemParams.objectid+'/links/'+link.linkid;repeatScope.updating=true;return $http.patch(url,{linkid:link.linkid,primarylink:primarylink}).then(function(response){updateItem(true).then(function(){repeatScope.updating=false;notify(response.data.message);});},notifyResponseMessage);};this.$onInit=function(){if(!this.skipupdate)
updateItem();}}]);geekApp.directive('editItemSelect',[function(){return{link:function(scope){scope.onAfterSaveFn=function(){return scope.onaftersave({fieldname:scope.fielddata.fieldname,value:scope.editModel});};},restrict:'E',templateUrl:'geekitem_edit_select.html',scope:{editModel:'=',fielddata:'=',onaftersave:'&'}};}]);
geekApp.directive('geekitemEditShortDescriptionButton',['$uibModal',function($modal){var link=function(scope,elem,atrr){var openModal=function(){$modal.open({controller:'GeekItem_ShortDescriptionCtrl',templateUrl:'geekitem_dialog_editshortdescription.tpl',controllerAs:'descctrl'});};elem.on('click',openModal);};return{link:link,restrict:'A'}}]);geekApp.controller('GeekItem_ShortDescriptionCtrl',['geekitemParams','geekmodHttpTools','notify',function(geekitemParams,geekmodHttpTools,notify){var that=this;this.newDesc='';this.saving=false;this.proposeChange=function(closer){that.saving=true;var desc=that.newDesc;if(desc.match(/\w$/)&&desc.length<85){desc=desc+'.';}
params={fieldname:'short_description',modtype:'datafield',objecttype:geekitemParams.objecttype,objectid:geekitemParams.objectid,assoc_objecttype:geekitemParams.objecttype,value:desc};geekmodHttpTools.saveProposal(params).then(function(response){notify(response.data.message);closer();},function(response){notify(response.data.error);that.saving=false;});};}]);
geekApp.directive('forumsModule',['geekAPIUrls',function(geekAPIUrls){var link=function(scope,element,attrs,ctrl){ctrl.url=geekAPIUrls.threads;ctrl.params={sort:ctrl.sort,forumid:ctrl.forumid,filterforums:'194',nosession:1};ctrl.showcountOptions=[15,25,50,100];ctrl.showcountkey='forumshowcount';ctrl.persistentParams=[{'name':'sort','persistentKey':'forumsort'},{'name':'showcount','persistentKey':ctrl.showcountkey},];ctrl.initDensity();ctrl.initParams();ctrl.getModule();};return{scope:{showcount:'@',showcounts:'=',tabData:'=',linkedForumTabData:'=',sort:'@',forumid:'@',rssFeed:'@',forumuid:'@',disablelocation:'@',densitykey:'@'},controller:'GeekItem_ModuleCtrl',controllerAs:'forumctrl',bindToController:true,link:link,templateUrl:'geekitem_module_forums.tpl'}}]);geekApp.directive('forumSearchPanel',[function(){return{restrict:'E',templateUrl:'geekitem_module_forums_searchpanel.tpl'};}]);geekApp.directive('forumsOverviewModule',['geekAPIUrls','geekitemSettings',function(geekAPIUrls,geekitemSettings){var link=function(scope,element,attrs,ctrl){ctrl.url=geekAPIUrls.threads;ctrl.disablelocation=true;ctrl.sorts=[];if(!geekitemSettings.overview_nohot){ctrl.sorts.push({sort:'hot',showcount:2});}
ctrl.sorts.push({sort:'recent',showcount:geekitemSettings.recentitems_showcount});ctrl.httpOptions={paramSerializer:'$httpParamSerializerJQLike'};ctrl.params={sorts:ctrl.sorts,showcount:3,showcounts:ctrl.showcounts,forumid:ctrl.forumid,nosession:1};ctrl.initParams();ctrl.getModule();};return{scope:{},controller:'GeekItem_ModuleCtrl',controllerAs:'forumctrl',bindToController:true,link:link,templateUrl:'geekitem_module_forums_overview.tpl'}}]);geekApp.directive('forumThreads',[function(){return{restrict:'E',scope:{threads:'=',sort:'=',showForum:'=',showItem:'=',articleShowcount:'=',forumid:'=',linkedforumIndex:'='},templateUrl:function(element,attrs){return"geekitem_module_forums_"+attrs.layout+".tpl";}};}]);geekApp.controller('GeekItem_ForumsTabCtrl',['$scope','$http','$state','$stateParams','geekitemParams','loadingTracker','geekitem','geekAPIUrls',function($scope,$http,$state,$stateParams,geekitemParams,loadingTracker,geekitem,geekAPIUrls){var that=this;var alltab={heading:'All',route:'geekitem.forums',params:{forumid:'0'}};alltab.href=$state.href(alltab.route,alltab.params);this.tabData=[alltab];this.forumid=$stateParams.forumid;this.linkedforum_index=$stateParams.linkedforum_index;this.loading=true;this.geekitemParams=geekitemParams;this.forumuids={};this.gotoState=function($event,route,params){$state.go(route,params);$event.preventDefault();};var getRssFeed=function(){if(that.linkedforum_index)
return;if(that.forumid&&that.forumid!=='0'){return"rss/uforum/"+that.forumuids[that.forumid];}else{return"forum/rss/0/"+that.geekitemParams.objecttype+"/"+that.geekitemParams.objectid;}};var getHasSubtypePredicate=function(subtypes){return function(forum_filter_type){return(!forum_filter_type.required_subtype)||subtypes.indexOf(forum_filter_type.required_subtype)>=0;};};var getHasLinkedItemsPredicate=function(linkcounts){return function(forum_filter_type){return(linkcounts[forum_filter_type.linkdata_index]>0);};};getForums=function(){var url=geekAPIUrls.forums;var promise=$http.get(url,{params:{objecttype:that.forumObjecttype,objectid:that.forumObjectid,subtype:that.forumSubtype},cache:true});loadingTracker.addPromise(promise);promise.then(function(response){that.loading=false;if(!that.linkedforum_index){that.tabData[0].count=_.sum(response.data.forums,'numthreads');}
_.forEach(response.data.forums,function(forum){if(forum.forumuid)
that.forumuids[forum.forumid]=forum.forumuid;var tab={heading:forum.title,route:'geekitem.forums',params:{forumid:forum.forumid}};if(!that.linkedforum_index){tab.count=forum.numthreads;}
tab.href=$state.href(tab.route,tab.params);that.tabData.push(tab);});that.rssFeed=getRssFeed();});};this.geekitem=new geekitem(that.geekitemParams);var initializeForumObject=function(){if(that.linkedforum_index){var linkdata_index=_.find(that.geekitem.data.item.linkedforum_types,{linkedforum_index:that.linkedforum_index}).linkdata_index;var linkdata=_.find(that.geekitem.data.item.itemdata,{keyname:linkdata_index});that.forumObjecttype=linkdata.other_objecttype;that.forumSubtype=linkdata.other_subtype;that.forumObjectid=0;}else{that.forumObjecttype=that.geekitemParams.objecttype;that.forumObjectid=that.geekitemParams.objectid;}};var initializeLinkedForumTabs=function(){var linked_forum_types=_(that.geekitem.data.item.linkedforum_types).filter(getHasSubtypePredicate(that.geekitem.data.item.subtypes)).filter(getHasLinkedItemsPredicate(that.geekitem.data.item.linkcounts)).value();that.linkedForumTabs=[];if(linked_forum_types.length){that.linkedForumTabs=_.map(linked_forum_types,function(linked_forum_info){return{heading:linked_forum_info.title,route:alltab.route,forceActive:linked_forum_info.linkedforum_index===that.linkedforum_index,params:{forumid:0,linkedforum_index:linked_forum_info.linkedforum_index}}});}
that.linkedForumTabs.unshift({heading:that.geekitem.data.item.subtypename+" Forums",route:alltab.route,forceActive:!that.linkedforum_index,params:{forumid:0,linkedforum_index:null}});};this.geekitem.getItem().then(function(){initializeLinkedForumTabs();initializeForumObject();getForums();});}]);
geekApp.factory('rankHttpTools',['$http','geekAPIUrls',function($http,geekAPIUrls){var tools={};tools.getRankGraph=function(objecttype,objectid,rankobjectid){var url=geekAPIUrls.historicalrankgraph;return $http.get(url,{'params':{objecttype:objecttype,objectid:objectid,rankobjectid:rankobjectid},cache:true});};return tools;}]);geekApp.directive('historicalRankStatsGraph',function(){return{scope:{objecttype:'@',objectid:'@',width:'@',height:'@',type:'@'},controller:'RankGraphCtrl',controllerAs:'graphctrl',bindToController:true,template:'<div id="highchart_container"></div>'}});geekApp.controller('RankGraphCtrl',['rankHttpTools','$location',function(rankHttpTools,$location){var that=this;this.$onInit=function(){that.loading=true;that.chart={};var urlParams=$location.search();this.rankobjectid=urlParams.rankobjectid;if(this.rankobjectid>0){rankHttpTools.getRankGraph(this.objecttype,this.objectid,this.rankobjectid).then(function(response){that.chart=response.data;that.loading=false;that.initChart();});}}
this.initChart=function(){Highcharts.stockChart('highchart_container',{chart:{zoomType:'x',},rangeSelector:{buttons:[{type:'week',count:1,text:'1w'},{type:'month',count:1,text:'1m'},{type:'month',count:6,text:'6m'},{type:'year',count:1,text:'1y'},{type:'all',text:'All'}],selected:2},yAxis:{reversed:true,min:1,title:{text:'Rank'},},tooltip:{valueDecimals:0,},series:[{name:'Rank',data:this.chart.data,}],accessibility:{description:'Historical graph of the game rank over time.'},});}}]);
geekApp.factory('geekItemHttpTools',['$http','loadingTracker','geekAPIUrls','$q',function($http,loadingTracker,geekAPIUrls,$q){var geekItemTools={};geekItemTools.itemNamespace=1;geekItemTools.clearCache=function(){geekItemTools.itemNamespace++;};geekItemTools.getItem=_.memoize(function(params){var url='/api/geekitems';var getParams=angular.copy(params);if(!params.useSession){url=geekAPIUrls.geekitems;getParams.nosession=1;}
var dynamicUrl=geekAPIUrls.dynamicinfo;var subtypeUrl=geekAPIUrls.subtypeinfo;var subtypeParams={subtype:getParams.subtype,nosession:1}
var promises=[loadingTracker.addPromise($http.get(url,{params:getParams}))];if(!getParams.nodynamic)
promises.push(loadingTracker.addPromise($http.get(dynamicUrl,{params:getParams})));if(getParams.subtype){promises.push(loadingTracker.addPromise($http.get(subtypeUrl,{params:subtypeParams})));}
return $q.all(promises).then(function(results){return _.merge.apply(this,results);});},function(params){var strParams={};_.forEach(params,function(value,key){strParams[key]=String(value);});var paramStr=JSON.stringify(strParams);return'getItem_'+paramStr.hashCode()+'_'+geekItemTools.itemNamespace;});return geekItemTools;}]);
geekApp.directive('uploadimage',function(){return{restrict:'A',replace:true,controller:'GeekItem_ImageUploadCtrl',controllerAs:'uploadimagectrl',bindToController:true}});geekApp.controller('GeekItem_ImageUploadCtrl',['$uibModal','geekGlobalSettings','notify',function($modal,geekGlobalSettings,notify){var that=this;this.popupImageUploader=function(objecttype,objectid){if(geekGlobalSettings.shutdown_image_upload>0){notify("Image uploads are temporarily disabled.");return;}
var modalInstance=$modal.open({templateUrl:'geekitem_dialog_uploadimage.tpl',controller:'UploadImageModalCtrl',backdrop:'static',size:'lg',resolve:{'geekobject':function(){return{'objecttype':objecttype,'objectid':objectid,}}}});modalInstance.result.then(function(){},function(){});};}]);geekApp.controller('UploadImageModalCtrl',['$scope','$uibModalInstance','FileUploader','geekobject','geekimageSettings',function($scope,$uibModalInstance,FileUploader,geekobject,geekimageSettings){$scope.geekobject=geekobject;$scope.geekimageSettings=geekimageSettings;if($scope.geekimageSettings.galleries)
delete($scope.geekimageSettings.galleries['all']);$scope.license=null;$scope.uploadAll=function(uploader){var hasError=false;_.each(uploader.queue,function(fileItem){fileItem.errors={};if(fileItem.sizechecked){if(fileItem.large){fileItem.errors.size="Image too large (>8600 pixels)";hasError=true;}else if(fileItem.small){fileItem.errors.size="Image too small (<320x200 pixels)";hasError=true;}}else{fileItem.errors.size="Image did not load";hasError=true;}
if(!fileItem.caption){fileItem.errors.caption="Caption required";hasError=true;}
if(!fileItem.gallery){fileItem.errors.gallery="Gallery required";hasError=true;}});if(!hasError)
uploader.uploadAll();};var uploader=$scope.uploader=new FileUploader({url:'/api/images'});uploader.filters.push({name:'imageFilter',fn:function(it,options){var type='|'+it.type.slice(it.type.lastIndexOf('/')+1)+'|';return'|jpg|png|jpeg|bmp|gif|'.indexOf(type)!==-1;}});uploader.onWhenAddingFileFailed=function(item,filter,options){};uploader.onAfterAddingFile=function(fileItem){var reader=new FileReader();reader.onload=function(event){var img=new Image();img.onload=function(){fileItem.sizechecked=true;if(img.width*img.height>75000000)
fileItem.large=true;else if(img.width*img.height<=64000)
fileItem.small=true;$scope.$apply();};img.src=event.target.result;};reader.readAsDataURL(fileItem._file);};uploader.onAfterAddingAll=function(addedFileItems){};uploader.onBeforeUploadItem=function(fileItem){fileItem.formData.push({'license[licenseid]':$scope.license.licenseid});if($scope.license.makedefault)
fileItem.formData.push({'license[makedefault]':true});fileItem.formData.push({'objecttype':$scope.geekobject.objecttype});fileItem.formData.push({'objectid':$scope.geekobject.objectid});if(fileItem.caption){fileItem.formData.push({'caption':fileItem.caption});}else{fileItem.captionerror='Caption required';fileItem.cancel();}
if(fileItem.gallery)
fileItem.formData.push({'gallery':fileItem.gallery});if(fileItem.adminnote)
fileItem.formData.push({'adminnote':fileItem.adminnote});};uploader.onProgressItem=function(fileItem,progress){};uploader.onProgressAll=function(progress){};uploader.onSuccessItem=function(fileItem,response,status,headers){if(response.imageid)
fileItem.imageid=response.imageid;};uploader.onErrorItem=function(fileItem,response,status,headers){fileItem.error=response.error;};uploader.onCancelItem=function(fileItem,response,status,headers){};uploader.onCompleteItem=function(fileItem,response,status,headers){};uploader.onCompleteAll=function(){};$scope.cancel=function(){$uibModalInstance.close();};}]);
geekApp.directive('linkimage',function(){return{restrict:'A',replace:true,controller:'GeekItem_LinkImageCtrl',controllerAs:'linkimagectrl',bindToController:true}});geekApp.controller('GeekItem_LinkImageCtrl',['$uibModal','imageHttpTools','notify',function($modal,imageHttpTools,notify){var that=this;this.removeImageLink=function(item,imageid){var params={objecttype:item.objecttype,objectid:item.objectid,imageid:imageid};imageHttpTools.removeImageLink(params).then(function(response){notify(response.data.message);},function error(response){notify({message:response.data.error,classes:'alert-danger'});});};this.popupLinkImage=function(src_item,dst_item){var modalInstance=$modal.open({templateUrl:'geekitem_dialog_linkimage.tpl',controller:'LinkImageModalCtrl',size:'lg',resolve:{'src_item':function(){return src_item;},'dst_item':function(){return dst_item;}}});modalInstance.result.then(function(selected){if(selected){imageHttpTools.saveImageLink({objecttype:dst_item.objecttype,objectid:dst_item.objectid,imageid:selected.imageid}).then(function(response){notify(response.data.message);},function error(response){notify({message:response.data.error,classes:'alert-danger'});});}},function(){});};}]);geekApp.controller('LinkImageModalCtrl',['$scope','$uibModalInstance','imageHttpTools','src_item','dst_item',function($scope,$uibModalInstance,imageHttpTools,src_item,dst_item){$scope.params={pageid:1,showcount:50,size:'micro',objecttype:src_item.objecttype,objectid:src_item.objectid,sort:'recent'};$scope.labels={sort:'Recent'};$scope.src_item=src_item;$scope.dst_item=dst_item;$scope.selected=null;$scope.save=function(){$uibModalInstance.close($scope.selected);};$scope.selectImage=function(image){$scope.selected=image;};$scope.getImages=function(){var params=angular.copy($scope.params);imageHttpTools.getImages(params).then(function(response){$scope.data=response.data;})};$scope.pageChanged=function(){$scope.getImages();};$scope.setParam=function(key,value){$scope.params[key]=value;$scope.getImages();};$scope.getImages();}]);
geekApp.directive('reviewsModule',['geekAPIUrls','geekitemSettings',function(geekAPIUrls,geekitemSettings){var link=function(scope,elements,attrs,ctrl){ctrl.disablelocation=true;ctrl.sorttypes=[{sort:'hot',name:'Hot'},{sort:'recent',name:'Recent'}];ctrl.url=geekAPIUrls.reviews;ctrl.params={};if(geekitemSettings.overview_nohot){ctrl.params.hotshowcount=0;}
ctrl.getModule();};return{scope:{},controller:'GeekItem_ModuleCtrl',controllerAs:'reviewctrl',bindToController:true,link:link,templateUrl:'geekitem_module_reviews.tpl'}}]);geekApp.directive('reviewsSubmodule',function(){return{scope:{reviews:'='},templateUrl:'geekitem_module_reviews_comfortable.tpl'}});geekApp.directive('blogsModule',function(){var link=function(scope,elements,attrs,ctrl){ctrl.url='/api/blogs/posts';ctrl.params={showcount:ctrl.showcount,blogid:ctrl.blogid,sort:ctrl.sort,interval:ctrl.interval,filterblogs:ctrl.filterblogs};ctrl.showcountOptions=[10,15,25,50];ctrl.showcountkey='blogsshowcount';ctrl.persistentParams=[{name:'showcount',persistentKey:ctrl.showcountkey}];ctrl.initParams();ctrl.getModule();};return{scope:{moduletitle:'@',blogid:'@',showcount:'@',sort:'@',showfooter:'@',nopager:'@',interval:'@',filterblogs:'@',geekitem:'='},controller:'GeekItem_ModuleCtrl',controllerAs:'blogctrl',link:link,bindToController:true,templateUrl:'geekitem_module_blogs.tpl'}});geekApp.directive('linkedItemsModule',['collectionHttpTools','geekAccount','collectionDataRepo','geekAPIUrls','geekAPIUrlsDirect',function(collectionHttpTools,geekAccount,collectionDataRepo,geekAPIUrls,geekAPIUrlsDirect){var link=function(scope,element,attrs,ctrl){ctrl.url=geekAPIUrls.linkeditems;ctrl.params={showcount:ctrl.showcount,linkdata_index:ctrl.linkdataIndex,subtype:ctrl.subtype,sort:ctrl.sort?ctrl.sort:'name'};ctrl.showcountOptions=[5,10,25];if(ctrl.includePending){geekAccount.admin.then(function(admin){if(admin.any){ctrl.url=geekAPIUrlsDirect.linkeditems;ctrl.params.includePending=1;}else{ctrl.params.nosession=1;}
ctrl.initParams();ctrl.getModule();});}else{ctrl.params.nosession=1;ctrl.initParams();ctrl.getModule();}};return{scope:{showcount:'@',linkdataIndex:'@',subtype:'@',moduletitle:'@',includePending:'@',sort:'@'},controller:'GeekItem_ModuleCtrl',controllerAs:'linkeditemctrl',bindToController:true,link:link,templateUrl:function(elem,attr){var types={'weblink':'weblinks','boardgamepodcastepisode':'podcasts','boardgameexpansion':'expansions','boardgameversion':'versions'};var module_suffix=types[attr.linkdataIndex]?types[attr.linkdataIndex]:'linkeditems';return'geekitem_module_'+module_suffix+'.tpl';}}}]);geekApp.directive('linkedItemsModuleRow',function(){return{restrict:'E',templateUrl:'geekitem_linkeditems_row.html',replace:true,scope:{item:'='}}});geekApp.directive('filesOverviewModule',['geekAPIUrls','geekitemSettings',function(geekAPIUrls,geekitemSettings){var link=function(scope,element,attrs,ctrl){ctrl.disablelocation=true;ctrl.sorts=[];if(!geekitemSettings.overview_nohot){ctrl.sorts.push({sort:'hot',showcount:2});}
ctrl.sorts.push({sort:'recent',showcount:2});ctrl.httpOptions={paramSerializer:'$httpParamSerializerJQLike'};ctrl.url=geekAPIUrls.files;ctrl.params={'sorts':ctrl.sorts,nosession:1};ctrl.initParams();ctrl.getModule();};return{scope:{},controller:'GeekItem_ModuleCtrl',controllerAs:'filectrl',link:link,bindToController:true,templateUrl:'geekitem_module_files_overview.tpl'}}]);geekApp.directive('overallRating',['$filter',function($filter){getRatingClass=function(stats){if(stats.usersrated<30)
return'has-rating-0';else return'has-rating-'+$filter('ratingColor')(stats.average);};getShowRating=function(item){if(item.stats.average<=0||item.stats.average==='0'){return false;}
if(item.stats.usersrated>=30){return true;}
var year=(new Date()).getFullYear();if(year>item.yearpublished){return true;}else{return false;}};var link=function(scope,element){scope.ratingClass=getRatingClass(scope.item.stats);scope.showRating=getShowRating(scope.item);};return{restrict:'E',scope:{item:'='},link:link,templateUrl:'geekitem_module_rating_overall.tpl'}}]);geekApp.directive('filesList',[function(){return{restrict:'E',scope:{files:'=',condensedSummary:'='},templateUrl:function(element,attrs){return"geekitem_module_files_"+attrs.layout+".tpl";}};}]);geekApp.directive('filesModule',['geekAPIUrls',function(geekAPIUrls){var link=function(scope,element,attrs,ctrl){ctrl.url=geekAPIUrls.files;ctrl.showcountOptions=[6,12,25,50];ctrl.showcountkey='filesshowcount';ctrl.persistentParams=[{name:'languageid','persistentKey':'languageid'},{name:'sort','persistentKey':'filesort'},{name:'showcount',persistentKey:ctrl.showcountkey}];ctrl.params={sort:ctrl.sort,nosession:1};ctrl.initDensity();ctrl.initParams();ctrl.getModule();};return{scope:{showcount:'@',showcounts:'=',sort:'@',disablelocation:'@',densitykey:'@'},controller:'GeekItem_ModuleCtrl',controllerAs:'filectrl',link:link,bindToController:true,templateUrl:'geekitem_module_files.tpl'}}]);geekApp.directive('imagesModule',['geekAPIUrls',function(geekAPIUrls){var link=function(scope,element,attrs,ctrl){ctrl.url=geekAPIUrls.images;ctrl.params={showcount:ctrl.showcount,sort:ctrl.sort,size:ctrl.size,gallery:ctrl.gallery,licensefilter:ctrl.licensefilter,pageid:1,nosession:1};ctrl.filters=['gallery','date','tag','licensefilter'];ctrl.showcountOptions=[8,16,36,48];ctrl.showcountkey='imagesshowcount';ctrl.persistentParams=[{name:'sort','persistentKey':'imagesort'},{name:'date','persistentKey':'date'},{name:'showcount',persistentKey:ctrl.showcountkey}];ctrl.initParams();ctrl.getModule();};return{scope:{showcount:'@',sort:'@',gallery:'@',size:'@'},controller:'GeekItem_ModuleCtrl',controllerAs:'imagectrl',link:link,bindToController:true,templateUrl:'geekitem_module_images.tpl'}}]);geekApp.directive('flagsModule',[function(){return{restrict:'E',templateUrl:'geekitem_module_flags.tpl',controller:'GeekItem_FlagsModuleCtrl',controllerAs:'geekitemctrl',bindToController:true,scope:{geekitem:'='}}}]);geekApp.directive('classificationsModule',[function(){return{restrict:'E',templateUrl:'geekitem_module_classifications.tpl',controller:'GeekItem_OverviewSubmoduleCtrl',controllerAs:'geekitemctrl',bindToController:true,scope:{geekitem:'='}}}]);geekApp.directive('gameplayModule',[function(){return{restrict:'E',templateUrl:'geekitem_module_gameplay.tpl',controller:'GeekItem_OverviewSubmoduleCtrl',controllerAs:'geekitemctrl',bindToController:true,scope:{geekitem:'='}}}]);geekApp.directive('officialLinksModule',[function(){return{restrict:'E',templateUrl:'geekitem_module_official_links.tpl',controller:'GeekItem_OverviewSubmoduleCtrl',controllerAs:'geekitemctrl',bindToController:true,scope:{geekitem:'='}}}]);geekApp.directive('statsModule',[function(){return{restrict:'E',templateUrl:'geekitem_module_stats.tpl',controller:'GeekItem_OverviewSubmoduleCtrl',controllerAs:'geekitemctrl',bindToController:true,scope:{geekitem:'='}}}]);geekApp.directive('kickstarterModule',[function(){return{restrict:'E',templateUrl:'geekitem_module_kickstarter.tpl',controller:'GeekItem_OverviewSubmoduleCtrl',controllerAs:'geekitemctrl',bindToController:true,scope:{geekitem:'='}}}]);geekApp.directive('shopifyModule',[function(){return{restrict:'E',templateUrl:'geekitem_module_shopify.tpl',controller:'GeekItem_OverviewSubmoduleCtrl',controllerAs:'geekitemctrl',bindToController:true,scope:{geekitem:'='}}}]);geekApp.directive('textAdModule',[function(){return{restrict:'E',templateUrl:'geekitem_module_textad.tpl',controller:'GeekItem_OverviewSubmoduleCtrl',controllerAs:'geekitemctrl',bindToController:true,scope:{geekitem:'='}}}]);geekApp.directive('geeklistsModule',['geekAPIUrls',function(geekAPIUrls){var link=function(scope,elements,attrs,ctrl){ctrl.url=geekAPIUrls.geeklists;ctrl.persistentParams=[{name:'sort','persistentKey':'geeklistsort'}];ctrl.params={showcount:ctrl.showcount,sort:ctrl.sort,nosession:1};if(attrs.view==='overview'){ctrl.params.itemcount=5;ctrl.disablelocation=true;}
ctrl.showcountOptions=[10,15,25,50];ctrl.showcountkey='geeklistsshowcount';ctrl.persistentParams=[{name:'showcount',persistentKey:ctrl.showcountkey}];ctrl.initParams();ctrl.getModule();};return{scope:{showcount:'@',sort:'@'},controller:'GeekItem_ModuleCtrl',controllerAs:'geeklistctrl',bindToController:true,link:link,templateUrl:function(elem,attrs){if(attrs.view==='overview')
return'geekitem_module_geeklists_overview.tpl';else
return'geekitem_module_geeklists.tpl';}}}]);geekApp.directive('geekmarketOverviewModule',['geekAPIUrls','$http',function(geekAPIUrls){var link=function(scope,element,attrs,ctrl){ctrl.disablelocation=true;ctrl.url=geekAPIUrls.geekmarketapi+"/products";ctrl.params={showcount:ctrl.showcount,stock:'instock',nosession:1};ctrl.getModule();};return{scope:{showcount:'@'},controller:'GeekItem_ModuleCtrl',controllerAs:'marketctrl',link:link,bindToController:true,templateUrl:'geekitem_module_geekmarket_overview.tpl'}}]);geekApp.directive('geekmarketTabModule',['geekAPIUrls','$http',function(geekAPIUrls,$http){var link=function(scope,element,attrs,ctrl){ctrl.url=geekAPIUrls.geekmarketapi+"/products";ctrl.params={showcount:ctrl.showcount,stock:'instock',nosession:1};ctrl.showcountOptions=[10,15,25,50];ctrl.showcountkey='marketshowcount';ctrl.persistentParams=[{name:'showcount',persistentKey:ctrl.showcountkey}];ctrl.getModule();if(ctrl.geekitemParams){$http.put('/api/viewdates',{},{params:ctrl.geekitemParams});}};return{scope:{showcount:'@'},controller:'GeekItem_ModuleCtrl',controllerAs:'marketctrl',link:link,bindToController:true,templateUrl:'geekitem_module_geekmarket_full.tpl'}}]);geekApp.directive('descriptionModule',function(){return{restrict:'E',templateUrl:'geekitem_module_description.tpl',controller:'GeekItem_OverviewSubmoduleCtrl',controllerAs:'geekitemctrl',bindToController:true,scope:{wikitext:'=',geekitem:'=',showclassifications:'=',showsuggestions:'=',showawards:'=',showads:'=',showofficiallinks:'=',expandabledescription:'='}}});geekApp.directive('wikiModule',function(){return{restrict:'E',templateUrl:'geekitem_module_wiki.tpl',controller:'GeekItem_OverviewSubmoduleCtrl',controllerAs:'geekitemctrl',bindToController:true,scope:{wikitext:'='}}});geekApp.directive('moreGameModule',function(){return{restrict:'E',templateUrl:'geekitem_module_moregame.tpl',controller:'GeekItem_OverviewSubmoduleCtrl',controllerAs:'geekitemctrl',bindToController:true,scope:{geekitem:'='}}});geekApp.directive('marketplaceModule',function(){return{restrict:'E',templateUrl:'geekitem_module_marketplace.tpl',controller:'GeekItem_OverviewSubmoduleCtrl',controllerAs:'geekitemctrl',bindToController:true,scope:{geekitem:'='}}});geekApp.directive('geekUpAdModule',function(){return{restrict:'E',templateUrl:'geekitem_module_geekup_ad.tpl',controller:'GeekItem_GeekUpAdModuleCtrl',controllerAs:'geekupctrl',bindToController:true,scope:{geekitem:'='}}});geekApp.directive('promotedvideosModule',function(){return{templateUrl:'geekitem_module_promotedvideos.tpl',controller:'GeekItem_PromotedVideosCtrl',controllerAs:'promotedvideosctrl',bindToController:true,scope:{geekitem:'='}}});geekApp.directive('mediaModule',function(){return{templateUrl:'geekitem_module_media.tpl'}});geekApp.directive('mobileStatsModules',function(){return{restrict:'E',templateUrl:'geekitem_module_mobilestats.tpl',controller:'GeekItem_OverviewSubmoduleCtrl',controllerAs:'geekitemctrl',bindToController:true,scope:{geekitem:'='}}});geekApp.directive('overviewModule',['$stateParams',function($stateParams){var template_version=null;var linkdata_index='';switch($stateParams.subtype){case'boardgame':case'boardgameaccessory':case'boardgameexpansion':case'rpgitem':template_version='v1';break;case'boardgamedesigner':case'boardgameartist':template_version='v2';linkdata_index=$stateParams.subtype;$showofficiallinks=1;break;case'boardgamepublisher':$showofficiallinks=1;case'boardgamemechanic':case'boardgamecategory':case'boardgamefamily':template_version='v2';linkdata_index='boardgame';break;}
var templates={v1:''+'<promotedvideos-module geekitem="overviewctrl.geekitem"></promotedvideos-module>'+'<text-ad-module geekitem="overviewctrl.geekitem"></text-ad-module>'+'<media-module></media-module>'+'<description-module wikitext="overviewctrl.geekitem.data.item.description" geekitem="overviewctrl.geekitem" showclassifications=1 showsuggestions=1 showawards=1 showads=1 showofficiallinks=1 expandabledescription=1></description-module>'+'<marketplace-module geekitem="overviewctrl.geekitem"></marketplace-module>'+'<span class=\'hidden-xs\'>\n'+'<videos-overview-module ng-if=\'!overviewctrl.geekitemSettings.overview_nohot\'></videos-overview-module>\n'+'<videos-overview-module-recent ng-if=\'overviewctrl.geekitemSettings.overview_nohot\'></videos-overview-module-recent>\n'+'</span>'+'<reviews-module disablelocation="true"></reviews-module>'+'<recs-module-overview title="Fans Also Like" recslink="geekitem.recs"></recs-module-overview>'+'<forums-overview-module disablelocation="true"></forums-overview-module>'+'<files-overview-module disablelocation="true"></files-overview-module>'+'<wiki-module wikitext="overviewctrl.geekitem.data.item.wiki"></wiki-module>'+'<more-game-module geekitem="overviewctrl.geekitem"></more-game-module>'+'<div class="hidden-xs"><geeklists-module showcount="4" view="overview"></geeklists-module></div>',v2:''+'<media-module></media-module>'+'<description-module wikitext="overviewctrl.geekitem.data.item.description" geekitem="overviewctrl.geekitem" showofficiallinks={$showofficiallinks}></description-module>'+'<recs-module-overview title="Top Games" recslink="geekitem.linkeditems" subtype="'+$stateParams.subtype+'" linkdataindex="'+linkdata_index+'"></recs-module-overview>'+'<wiki-module wikitext="overviewctrl.geekitem.data.item.wiki"></wiki-module>'};return{controller:'GeekItem_OverviewCtrl',controllerAs:'overviewctrl',template:templates[template_version],bindToController:true,scope:{moduleindex:'@',geekitem:'='}}}]);geekApp.directive('awardsModule',function(){return{controller:'GeekItem_AwardsCtrl',controllerAs:'awardsctrl',bindToController:true,templateUrl:'geekitem_module_awards.tpl',scope:{linkshowcount:'@'}}});geekApp.directive('creditsModule',function(){return{controller:'GeekItem_FullCreditsCtrl',controllerAs:'creditsctrl',templateUrl:'geekitem_module_fullcredits.tpl'}});geekApp.directive('adminNotesModule',function(){return{controller:'GeekItem_AdminNotesCtrl',controllerAs:'adminnotesctrl',bindToController:true,templateUrl:'geekitem_module_adminnotes.tpl'}});geekApp.directive('collectionModule',function(){return{scope:{item:'='},controller:'GeekCollection_ModuleCtrl',controllerAs:'collectionctrl',bindToController:true,templateUrl:'geekitem_module_collection.tpl'}});geekApp.directive('playsModule',function(){return{controller:'GeekItem_PlayCtrl',controllerAs:'playctrl',bindToController:true,templateUrl:'geekitem_module_myplays.tpl'}});geekApp.directive('tagsModule',function(){return{scope:{params:'='},controller:'GeekTag_ModuleCtrl',controllerAs:'tagctrl',bindToController:true,templateUrl:'geekitem_module_tags.tpl'}});geekApp.directive('ratingsModule',['collectionHttpTools','geekAPIUrls',function(collectionHttpTools,geekAPIUrls){var link=function(scope,element,attrs,ctrl){ctrl.url=geekAPIUrls.collections;ctrl.params={showcount:ctrl.showcount,sort:'review_tstamp',require_review:true};var params={objecttype:ctrl.objecttype,objectid:ctrl.objectid};ctrl.showcountOptions=[15,25,50,100];ctrl.showcountkey='ratingsshowcount';ctrl.persistentParams=[{name:'sort',persistentKey:'ratingsort'},{name:'showcount',persistentKey:ctrl.showcountkey}];ctrl.ratings=_.range(10,0,-1);collectionHttpTools.getConfig(params).then(function(response){ctrl.config=response.data;ctrl.config.sorttypes=[{type:'review_tstamp',name:'Date'},{type:'rating',name:'Rating'}];ctrl.config.resetFilterValues=[{name:'rated',value:''},{name:'rating',value:''},{name:'comment',value:'1'},{name:'status',value:''}];ctrl.initParams();ctrl.params.oneperuser=ctrl.params.comment?0:1;ctrl.getModule();});};return{link:link,controller:'GeekItem_ModuleCtrl',controllerAs:'ratingsctrl',bindToController:true,templateUrl:'geekitem_module_ratings.tpl',scope:{objecttype:'=',objectid:'=',showcount:'=',geekitem:"="}}}]);geekApp.directive('tradingModule',['collectionHttpTools','geekAPIUrls',function(collectionHttpTools,geekAPIUrls){var link=function(scope,element,attrs,ctrl){ctrl.url=geekAPIUrls.collections;ctrl.params={showcount:ctrl.showcount,includeversions:true};ctrl.showcountOptions=[15,25,50,100];ctrl.showcountkey='tradingshowcount';ctrl.persistentParams=[{name:'showcount',persistentKey:ctrl.showcountkey}];var params={objecttype:ctrl.objecttype,objectid:ctrl.objectid};collectionHttpTools.getConfig(params).then(function(response){ctrl.config=response.data;ctrl.initParams();ctrl.getModule();});};return{link:link,controller:'GeekItem_ModuleCtrl',controllerAs:'ratingsctrl',bindToController:true,templateUrl:'geekitem_module_trading.tpl',scope:{objecttype:'=',objectid:'=',showcount:'='}}}]);geekApp.directive('convertToNumber',function(){return{require:'ngModel',link:function(scope,element,attrs,ngModel){ngModel.$parsers.push(function(val){return parseInt(val,10);});ngModel.$formatters.push(function(val){return''+val;});}};});
geekApp.controller('GeekItem_ModuleCtrl',['moduleLoader','geekitemParams','geekScroller','$location','$document','$scope','$state','$localStorage','geekitemSettings',function(moduleLoader,geekitemParams,geekScroller,$location,$document,$scope,$state,$localStorage,geekitemSettings){var that=this;this.geekitemParams=geekitemParams;this.geekitemSettings=geekitemSettings;this.loader=[];this.firstload=false;that.$storage=$localStorage;var hiddenValues=['showcount'];this.data={config:{numitems:999999}};this.$postLink=function(){if(!that.disablelocation){$scope.$on('$locationChangeSuccess',that.updateModule);}};this.gotoState=function($event,stateurl,params){$state.go(stateurl,params);$event.preventDefault();$event.stopPropagation();};this.showMore=function(){this.params.showcount=+this.params.showcount+10;this.getModule();};this.initParams=function(){var urlParams=$location.search();if(that.persistentParams){_.each(that.persistentParams,function(param){if((typeof urlParams[param.name]==='undefined')&&(typeof $localStorage[param.persistentKey]!=='undefined'))
that.params[param.name]=$localStorage[param.persistentKey];});}
that.params.objecttype=geekitemParams.objecttype;that.params.objectid=geekitemParams.objectid;if(!urlParams.pageid)
urlParams.pageid=1;angular.extend(that.params,urlParams);};this.initDensity=function(){that.density=$localStorage[that.densitykey]||'comfortable';if(that.showcount)
that.params.showcount=that.showcount;else
that.params.showcount=that.showcounts[that.density];};this.clearFilters=function(){_.forEach(that.filters,function(filter){that.params[filter]='';if(!that.disablelocation)
$location.search(filter,null);});that.setPage(1);};this.filtersAreReset=function(){if(that.config&&that.config.resetFilterValues){var filterIsDirty=function(filter){if(filter.value===''&&typeof that.params[filter.name]==='undefined')
return false;return that.params[filter.name]!=filter.value;};if(_.some(that.config.resetFilterValues,filterIsDirty)){return false;}}
return true;};this.resetFilters=function(){if(that.config&&that.config.resetFilterValues)
_.forEach(that.config.resetFilterValues,function(filter){that.params[filter.name]=filter.value;if(!that.disablelocation){if(filter.value==='')
$location.search(filter.name,null);else
$location.search(filter.name,filter.value);}});that.setPage(1);};this.anyFiltersAreSet=function(){return _.some(that.filters,function(filter){return that.params[filter]&&that.params[filter]!='all';});};this.anyFiltersFromArrayAreSet=function(filters){return _.some(filters,function(filter){return that.params[filter.type]&&that.params[filter.type]!='all';});};this.getFilterHeader=function(filter,value,defaultValue){if(!value||value==filter[0].type)
return defaultValue;var filtered=_.find(filter,{type:value});return filtered?filtered.name:defaultValue;};var setPersistentParam=function(param,value){if(!that.persistentParams)
return;var persistentParam=_.find(that.persistentParams,{name:param});if(persistentParam){$localStorage[persistentParam.persistentKey]=value;}};this.setParam=function(param,value){that.params[param]=value;setPersistentParam(param,value);var updatingHidden=hiddenValues.indexOf(param)>=0;if(!that.disablelocation&&!updatingHidden)
$location.search(param,value);that.setPage(1);if(updatingHidden)
that.updateModule();};this.clearParam=function(param){delete(that.params[param]);setPersistentParam(param,null);if(!this.disablelocation)
$location.search(param,null);that.setPage(1);};this.pageChanged=function(){this.setPage(this.params.pageid);};this.pageForward=function(){this.setPage(this.params.pageid+1);};this.pageBackward=function(){if(this.params.pageid>1){this.setPage(this.params.pageid-1);}};this.pageToFirst=function(){this.setPage(1);};this.setPage=function(pageid){that.params.pageid=pageid;if(that.disablelocation){that.updateModule();}
else{$location.search('pageid',pageid);geekScroller.scrollIntoViewByName('tab');}};this.getModule=function(){if(!that.params||!that.params.objectid)
that.initParams();var loader=moduleLoader.getModule(that.url,that.params,that.httpOptions);that.loader=loader;that.loaded=false;loader.then(function(response){that.data=response.data;that.loaded=true;that.firstload=true;return response;});return loader;};this.updateModule=function(){that.initParams();that.getModule();};if(this.showcounts){$scope.$watch(function(){return that.density;},function(current,original){if(current&&current!==original){that.setParam('showcount',that.showcounts[that.density]);that.getModule();}});}}]);geekApp.factory('moduleLoader',['$http','loadingTracker',function($http,loadingTracker){var moduleLoader={};var getTrackedModuleLoader=function(url,options){options.cache=true;return loadingTracker.addPromise($http.get(url,options));};moduleLoader.getModule=function(url,params,options){params.ajax=1;options=options?options:{};options.params=params;return getTrackedModuleLoader(url,options);};return moduleLoader;}]);
geekApp.controller('GeekItemChartCtrl',['$scope','$uibModal',function($scope,$modal){$scope.showRatings=function(objecttype,objectid,type){var modalInstance=$modal.open({templateUrl:'geekitem_dialog_ratingsgraph.tpl',controller:'RatingGraphDialogCtrl',windowClass:'modal-fixed-right',size:'lg',resolve:{'graphitem':function(){return{objecttype:objecttype,objectid:objectid,type:type}}}});modalInstance.result.then(function(){},function(){});};}]);geekApp.factory('ratingHttpTools',['$http',function($http){var ratingTools={};ratingTools.getRatingGraph=function(objecttype,objectid,type){return $http.get('/api/collectionstatsgraph',{'params':{objecttype:objecttype,objectid:objectid,type:type},cache:true});};return ratingTools;}]);geekApp.directive('ratingsStatsGraph',function(){return{scope:{objecttype:'@',objectid:'@',width:'@',height:'@',type:'@'},controller:'RatingGraphCtrl',controllerAs:'ratingsgraphctrl',bindToController:true,template:'<div ng-if="!ratingsgraphctrl.loading" '+'google-chart chart="ratingsgraphctrl.chart" '+'style="{{ratingsgraphctrl.width}}px; height:{{ratingsgraphctrl.height}}px;" '+'agc-on-click="ratingsgraphctrl.onClick(args)" '+'agc-on-select="ratingsgraphctrl.selectRating(selectedItems)"></div>'}});geekApp.controller('RatingGraphDialogCtrl',['$scope','ratingHttpTools','graphitem',function($scope,ratingHttpTools,graphitem){$scope.graphitem=graphitem;}]);geekApp.controller('RatingGraphCtrl',['ratingHttpTools','$state',function(ratingHttpTools,$state){var that=this;that.selectRating=function(selectedItems){var row=selectedItems[0].row;var idcol=_.findIndex(that.chart.data.cols,{id:'rating'});var rating=that.chart.data.rows[row].c[idcol].v;redirectByRating(rating);};that.onClick=function(args){var pattern=/^hAxis#0#label#(\d+)$/;var matches=pattern.exec(args[0].targetID);if(matches){redirectByRating(+matches[1]+1);}};var redirectByRating=function(rating){$state.go('geekitem.ratings',{rating:rating,rated:'',comment:'',status:''});};this.$onInit=function(){that.loading=true;ratingHttpTools.getRatingGraph(this.objecttype,this.objectid,this.type).then(function(response){that.chart=response.data;that.loading=false;});}}]);
geekApp.config(['$stateProvider','$urlRouterProvider',function($stateProvider,$urlRouterProvider){$urlRouterProvider.rule(function($injector,$location){var path=$location.path();var hasTrailingSlash=path[path.length-1]==='/';if(hasTrailingSlash){return path.substr(0,path.length-1);}});$urlRouterProvider.when("/boardgamedesigner/:objectid/:slug/linkeditems","/boardgamedesigner/:objectid/:slug/linkeditems/boardgamedesigner");$urlRouterProvider.when("/boardgameartist/:objectid/:slug/linkeditems","/boardgameartist/:objectid/:slug/linkeditems/boardgameartist");$urlRouterProvider.when("/boardgamepublisher/:objectid/:slug/linkeditems","/boardgamepublisher/:objectid/:slug/linkeditems/boardgamepublisher");$urlRouterProvider.when("/boardgamecategory/:objectid/:slug/linkeditems","/boardgamecategory/:objectid/:slug/linkeditems/boardgamecategory");$urlRouterProvider.when("/boardgamemechanic/:objectid/:slug/linkeditems","/boardgamemechanic/:objectid/:slug/linkeditems/boardgamemechanic");$urlRouterProvider.when("/boardgamefamily/:objectid/:slug/linkeditems","/boardgamefamily/:objectid/:slug/linkeditems/boardgamefamily");$urlRouterProvider.when("/:subtype/:objectid/:slug/linkeditems","/:subtype/:objectid/:slug/linkeditems/accessories");$urlRouterProvider.when("/:subtype/:objectid/:slug/mentions","/:subtype/:objectid/:slug/mentions/news");$urlRouterProvider.when("/:subtype/:objectid/:slug/mygames","/:subtype/:objectid/:slug/mygames/collection");$urlRouterProvider.when("/:subtype/:objectid/:slug/marketplace","/:subtype/:objectid/:slug/marketplace/geekmarket");$stateProvider.state('geekitem',{abstract:true,url:'/:subtype/:objectid/:slug',template:'<ui-view autoscroll="false"/>'}).state('geekitem.overview',{url:'',templateUrl:'geekitem_tab_overview.tpl',params:{'#':null}}).state('geekitem.stats',{url:'/stats',templateUrl:'geekitem_tab_stats.tpl'}).state('geekitem.statshistory',{url:'/stats/history?rankobjectid',templateUrl:'geekitem_tab_stats_history.tpl',}).state('geekitem.marketplace',{url:'/marketplace',templateUrl:'geekitem_tab_marketplace.tpl'}).state('geekitem.marketplace.geekmarket',{url:'/geekmarket',templateUrl:'geekitem_tab_geekmarket.tpl'}).state('geekitem.marketplace.ebay',{url:'/ebay',templateUrl:'geekitem_tab_ebay.tpl'}).state('geekitem.forums',{url:'/forums/{forumid}?sort&linkedforum_index',controller:'GeekItem_ForumsTabCtrl',controllerAs:'forumstabctrl',templateUrl:'geekitem_tab_forums.tpl',params:{forumid:{value:'0'},linkedforum_index:{value:undefined}}}).state('geekitem.wiki',{url:'/wiki',templateUrl:'geekitem_tab_wiki.tpl'}).state('geekitem.mentions',{url:'/mentions',templateUrl:'geekitem_tab_mentions.tpl'}).state('geekitem.mygames',{url:'/mygames',templateUrl:'geekitem_tab_mygames.tpl'}).state('geekitem.expansions',{url:'/expansions',templateUrl:'geekitem_tab_expansions.tpl'}).state('geekitem.mygames.plays',{url:'/plays',templateUrl:'geekitem_tab_myplays.tpl'}).state('geekitem.mygames.tags',{url:'/tags',templateUrl:'geekitem_tab_tags.tpl'}).state('geekitem.mygames.collection',{url:'/collection',templateUrl:'geekitem_tab_collection.tpl'}).state('geekitem.mygames.collection.editcollection',{url:'/editcollection/{collid}',params:{status:null},onEnter:['$stateParams','$state','$uibModal',function($stateParams,$state,$modal){$modal.open({controller:'GeekCollection_EditorCtrl',controllerAs:'editctrl',confirmOnDismiss:true,windowClass:'modal-fixed-right',templateUrl:'geekitem_dialog_editcollection.tpl',resolve:{additem:function(){return{};}}}).result.finally(function(){$state.go('geekitem.mygames.collection');});}]}).state('geekitem.mygames.collection.addtocollection',{url:'/addto',params:{status:null,versionid:null},onEnter:['$stateParams','$state','$uibModal',function($stateParams,$state,$modal){$modal.open({controller:'GeekCollection_EditorCtrl',controllerAs:'editctrl',confirmOnDismiss:true,windowClass:'modal-fixed-right',templateUrl:'geekitem_dialog_editcollection.tpl',resolve:{additem:function(){return{};}}});}]}).state('geekitem.versions',{url:'/versions',templateUrl:'geekitem_tab_versions.tpl'}).state('geekitem.linkeditems',{url:'/linkeditems',controller:'GeekItem_LinkedItemsCtrl',controllerAs:'linkeditemsctrl',templateUrl:'geekitem_tab_linkeditems.tpl'}).state('geekitem.geeklists',{url:'/geeklists',templateUrl:'geekitem_tab_geeklists.tpl'}).state('geekitem.images',{url:'/images',templateUrl:'geekitem_tab_images.tpl'}).state('geekitem.videos',{url:'/videos/{gallery}?sort',controller:'GeekItem_VideosTabCtrl',controllerAs:'videostabctrl',templateUrl:'geekitem_tab_videos.tpl',params:{gallery:{value:'all'}}}).state('geekitem.files',{url:'/files',templateUrl:'geekitem_tab_files.tpl'}).state('geekitem.podcasts',{url:'/podcasts',templateUrl:'geekitem_tab_podcasts.tpl'}).state('geekitem.credits',{url:'/credits',templateUrl:'geekitem_tab_fullcredits.tpl',params:{'#':{value:null}}}).state('geekitem.edit',{url:'/edit',templateUrl:'geekitem_tab_edit.tpl',controller:'GeekItem_EditCtrl',controllerAs:'geekitemeditctrl'}).state('geekitem.mentions.news',{url:'/news',templateUrl:'geekitem_tab_news.tpl'}).state('geekitem.mentions.blogs',{url:'/blogs',templateUrl:'geekitem_tab_blogs.tpl'}).state('geekitem.mentions.links',{url:'/links',templateUrl:'geekitem_tab_links.tpl'}).state('geekitem.mentions.podcasts',{url:'/podcasts',templateUrl:'geekitem_tab_podcasts.tpl'}).state('geekitem.linkeditems.boardgamedesigner',{url:'/boardgamedesigner',template:'<div class=\'global-body-content-primary\'>\n'+'<linked-items-module subtype="boardgame"\n'+'                     linkdata_index="boardgamedesigner"\n'+'                     moduletitle="Designer"\n'+'                     showcount="25">\n'+'</linked-items-module>\n'+'</div>\n'}).state('geekitem.linkeditems.boardgameartist',{url:'/boardgameartist',template:'<div class=\'global-body-content-primary\'>\n'+'<linked-items-module subtype="boardgame"\n'+'                     linkdata_index="boardgameartist"\n'+'                     moduletitle="Artist"\n'+'                     showcount="25">\n'+'</linked-items-module>\n'+'</div>\n'}).state('geekitem.linkeditems.boardgameaccessorydesigner',{url:'/boardgameaccessorydesigner',template:'<div class="global-body-content-primary">\n'+'<linked-items-module subtype="boardgameaccessory"\n'+'                     linkdata_index="boardgameaccessorydesigner"\n'+'                     moduletitle="Designed Accessories"\n'+'                     showcount="25">\n'+'</linked-items-module>\n'+'</div>\n'}).state('geekitem.linkeditems.boardgamepublisher',{url:'/boardgamepublisher',template:'<div class="global-body-content-primary">\n'+'<linked-items-module subtype="boardgamepublisher"\n'+'                     linkdata_index="boardgame"\n'+'                     moduletitle="Board Games"\n'+'                     showcount="25">\n'+'</linked-items-module>\n'+'</div>\n'}).state('geekitem.linkeditems.boardgamecategory',{url:'/boardgamecategory',template:'<div class="global-body-content-primary">\n'+'<linked-items-module subtype="boardgamecategory"\n'+'                     linkdata_index="boardgame"\n'+'                     moduletitle="Board Games"\n'+'                     showcount="25">\n'+'</linked-items-module>\n'+'</div>\n'}).state('geekitem.linkeditems.boardgamemechanic',{url:'/boardgamemechanic',template:'<div class="global-body-content-primary">\n'+'<linked-items-module subtype="boardgamemechanic"\n'+'                     linkdata_index="boardgame"\n'+'                     moduletitle="Board Games"\n'+'                     showcount="25">\n'+'</linked-items-module>\n'+'</div>\n'}).state('geekitem.linkeditems.boardgamefamily',{url:'/boardgamefamily',template:'<div class="global-body-content-primary">\n'+'<linked-items-module subtype="boardgamefamily"\n'+'                     linkdata_index="boardgame"\n'+'                     moduletitle="Board Games"\n'+'                     showcount="25">\n'+'</linked-items-module>\n'+'</div>\n'}).state('geekitem.linkeditems.boardgameaccessory',{url:'/accessories',templateUrl:'geekitem_tab_accessories.tpl'}).state('geekitem.linkeditems.contains',{url:'/contains',templateUrl:'geekitem_tab_contains.tpl'}).state('geekitem.linkeditems.containedin',{url:'/containedin',templateUrl:'geekitem_tab_containedin.tpl'}).state('geekitem.linkeditems.reimplementation',{url:'/reimplementedby',templateUrl:'geekitem_tab_reimplementedby.tpl'}).state('geekitem.linkeditems.reimplements',{url:'/reimplements',templateUrl:'geekitem_tab_reimplements.tpl'}).state('geekitem.linkeditems.boardgameintegration',{url:'/integrateswith',templateUrl:'geekitem_tab_boardgameintegration.tpl'}).state('geekitem.linkeditems.videogamebg',{url:'/videogameadaptation',templateUrl:'geekitem_tab_videogameadaptation.tpl'}).state('geekitem.textads',{url:'/textads',templateUrl:'geekitem_tab_textads.tpl'}).state('geekitem.ratings',{url:'/ratings?rated&rating&comment&status',templateUrl:'geekitem_tab_ratings.tpl'}).state('geekitem.trading',{url:'/trading?status',templateUrl:'geekitem_tab_trading.tpl',params:{status:'fortrade'}}).state('geekitem.recs',{url:'/recommendations',templateUrl:'geekitem_tab_recs.tpl'})}]);
geekApp.constant('geekitemTabs',{property:[{heading:'Overview',route:'geekitem.overview',type:'tab',mobile:true},{heading:'Linked Games',route:'geekitem.linkeditems',type:'tab',mobile:true},{heading:'Forums',route:'geekitem.forums',type:'tab',mobile:true},{heading:'Images',route:'geekitem.images',type:'tab',mobile:true},{heading:'GeekLists',route:'geekitem.geeklists',type:'tab',mobile:true}],boardgamegeneric:[{heading:'Overview',route:'geekitem.overview',type:'tab',mobile:true},{heading:'Linked Games',route:'geekitem.linkeditems',type:'tab',mobile:true},{heading:'Forums',route:'geekitem.forums',type:'tab',mobile:true},{heading:'Images',route:'geekitem.images',type:'tab',mobile:true},{heading:'Videos',route:'geekitem.videos',type:'tab',mobile:true},{heading:'GeekLists',route:'geekitem.geeklists',menuType:'tab',type:'tab'},{heading:'Other Links',route:'geekitem.mentions',menuType:'tab',type:'tab'}],boardgame:[{heading:'Overview',route:'geekitem.overview',type:'tab',mobile:true},{heading:'Ratings',route:'geekitem.ratings',menuType:'game',type:'tab',mobile:false},{heading:'Forums',route:'geekitem.forums',type:'tab',mobile:true},{heading:'Images',route:'geekitem.images',type:'tab',mobile:true},{heading:'Videos',route:'geekitem.videos',type:'tab',mobile:false},{heading:'Files',route:'geekitem.files',type:'tab',mobile:false},{heading:'Stats',route:'geekitem.stats',type:'tab',mobile:false},{heading:'Versions',route:'geekitem.versions',type:'tab',mobile:false},{heading:'Expansions',route:'geekitem.expansions',type:'tab',mobile:false},{heading:'My Games',route:'geekitem.mygames',type:'tab',mobile:false},{heading:'Market',route:'geekitem.marketplace',type:'tab',mobile:false},{heading:'Fans Also Like',route:'geekitem.recs',menuType:'learn',type:'menu'},{heading:'Web Links',route:'geekitem.mentions.links',menuType:'learn',type:'menu'},{heading:'BGG News',route:'geekitem.mentions.news',menuType:'learn',type:'menu'},{heading:'BGG Blog Posts',route:'geekitem.mentions.blogs',menuType:'learn',type:'menu'},{heading:'Podcasts',route:'geekitem.mentions.podcasts',menuType:'learn',type:'menu'},{heading:'Full Credits',route:'geekitem.credits',menuType:'game',type:'menu'},{heading:'Linked Items',route:'geekitem.linkeditems',menuType:'game',type:'menu'},{heading:'Community Wiki',route:'geekitem.wiki',menuType:'game',type:'menu'},{heading:'Community Tags',route:'geekitem.mygames.tags',menuType:'game',type:'menu'},{heading:'GeekLists',route:'geekitem.geeklists',menuType:'game',type:'menu'},{heading:'GeekTrade',route:'geekitem.trading',menuType:'game',params:{status:'fortrade'},type:'menu'}]});geekApp.constant('linkeditemsTabs',{'boardgameproperty':[{heading:'Board Games',route:'geekitem.linkeditems.boardgamepublisher',linkkeys:'boardgamepublisher'}],'boardgamepublisher':[{heading:'Board Games',route:'geekitem.linkeditems.boardgamepublisher',linkkeys:'boardgamepublisher'},{heading:'Accessories',route:'geekitem.linkeditems.boardgameaccessory',linkkeys:'boardgamepublisher'}],'boardgameperson':[{heading:'Designer',route:'geekitem.linkeditems.boardgamedesigner',linkkeys:'boardgamedesigner'},{heading:'Artist',route:'geekitem.linkeditems.boardgameartist',linkkeys:'boardgameartist'},{heading:'Accessory Designer',route:'geekitem.linkeditems.boardgameaccessorydesigner',linkkeys:'boardgameaccessorydesigner'}],'boardgame':[{heading:'Accessories',route:'geekitem.linkeditems.boardgameaccessory',linkkey:'boardgameaccessory'},{heading:'Contains',route:'geekitem.linkeditems.contains',linkkey:'contains'},{heading:'Contained In',route:'geekitem.linkeditems.containedin',linkkey:'containedin'},{heading:'Reimplemented By',route:'geekitem.linkeditems.reimplementation',linkkey:'reimplementation'},{heading:'Reimplements',route:'geekitem.linkeditems.reimplements',linkkey:'reimplements'},{heading:'Integrates With',route:'geekitem.linkeditems.boardgameintegration',linkkey:'boardgameintegration'},{heading:'Video Game Adaptation',route:'geekitem.linkeditems.videogamebg',linkkey:'videogamebg'}]});
geekApp.directive('videosModule',['geekAPIUrls',function(geekAPIUrls){var link=function(scope,element,attrs,ctrl){ctrl.url=geekAPIUrls.videos;ctrl.showcountOptions=[6,12,24,36,50];ctrl.showcountkey='videosshowcount';ctrl.persistentParams=[{name:'languageid','persistentKey':'languageid'},{name:'sort',persistentKey:'videosort'},{name:'showcount',persistentKey:ctrl.showcountkey}];ctrl.params={sort:ctrl.sort,gallery:ctrl.gallery,languageid:ctrl.languageid,pageid:1,nosession:1};ctrl.initDensity();ctrl.updateModule();};return{scope:{showcounts:'=',sort:'@',gallery:'@',languageid:'@',tabData:'=',densitykey:'@'},restrict:'E',replace:true,controller:'GeekItem_ModuleCtrl',controllerAs:'videoctrl',link:link,bindToController:true,templateUrl:'geekitem_module_videos.tpl'}}]);geekApp.directive('videosOverviewModuleRecent',['geekAPIUrls',function(geekAPIUrls){var link=function(scope,element,attrs,ctrl){ctrl.url=geekAPIUrls.videos;ctrl.params={nosession:1,sort:'recent',showcount:3};ctrl.initParams();ctrl.getModule();};return{scope:{},restrict:'E',replace:true,controller:'GeekItem_ModuleCtrl',controllerAs:'videoctrl',link:link,bindToController:true,templateUrl:'geekitem_module_videos_overview_recent.tpl'}}]);geekApp.directive('videosOverviewModule',['geekAPIUrls',function(geekAPIUrls){var link=function(scope,element,attrs,ctrl){ctrl.url=geekAPIUrls.videos+'/overview';ctrl.disablelocation=true;ctrl.params={nosession:1};ctrl.getModule();};return{scope:{},restrict:'E',replace:true,controller:'GeekItem_ModuleCtrl',controllerAs:'videoctrl',link:link,bindToController:true,templateUrl:'geekitem_module_videos_overview.tpl'}}]);geekApp.directive('geekVideo',function(){return{restrict:'E',scope:{video:'=',languageid:'@',setParam:'='},templateUrl:'video_comfortable.html'}});geekApp.controller('GeekItem_VideosTabCtrl',['$scope','$http','$state','$stateParams','geekitemParams','loadingTracker','geekitemPreload',function($scope,$http,$state,$stateParams,geekitemParams,loadingTracker,geekitemPreload){var that=this;this.tabData=[];this.gallery=$stateParams.gallery;this.galleries={};this.updateGalleries=function(galleries){_.forEach(galleries,function(gallery){that.galleries[gallery.type]=gallery.type;var tab={heading:gallery.name,route:'geekitem.videos',params:{gallery:gallery.type}};tab.href=$state.href(tab.route,tab.params);that.tabData.push(tab);});};this.loadGalleries=function(){this.loading=true;this.geekitemParams=geekitemParams;if(geekitemPreload.videogalleries){this.updateGalleries(geekitemPreload.videogalleries.galleries);that.loading=false;}
else{var promise=$http.get('/api/videogalleries',{params:{objecttype:this.geekitemParams.objecttype,objectid:this.geekitemParams.objectid},cache:true});loadingTracker.addPromise(promise);promise.then(function(response){that.updateGalleries(response.data.galleries);that.loading=false;});}};this.loadGalleries();}]);
geekApp.directive('recsModule',['geekAPIUrls',function(geekAPIUrls){var link=function(scope,element,attrs,ctrl){ctrl.url=geekAPIUrls.recs;ctrl.showcountOptions=[5,10,15,20];ctrl.showcountkey='recsshowcount';ctrl.params={objectid:ctrl.objectid};ctrl.updateModule();};return{scope:{showcounts:'='},restrict:'E',replace:true,controller:'GeekItem_ModuleCtrl',controllerAs:'recsctrl',link:link,bindToController:true,templateUrl:'geekitem_module_recs.tpl'}}]);geekApp.directive('recsModuleOverview',['geekAPIUrls',function(geekAPIUrls){var link=function(scope,element,attrs,ctrl){ctrl.url=geekAPIUrls.recs;ctrl.showcountOptions=[5,10,15,20];ctrl.showcountkey='recsshowcount';ctrl.params={};if(attrs.subtype)
ctrl.url+='/'+attrs.subtype;if(attrs.linkdataindex)
ctrl.params.linkdata_index=attrs.linkdataindex;ctrl.updateModule();};return{scope:{subtype:'@',title:'@',recslink:'@',linkdataindex:'@'},restrict:'E',replace:false,controller:'GeekItem_ModuleCtrl',controllerAs:'recsctrl',link:link,bindToController:true,templateUrl:'geekitem_module_recs_overview.tpl'}}]);
geekApp.factory('fanHttpTools',['$http','loadingTracker','geekAPIUrls',function($http,loadingTracker,geekAPIUrls){var fanTools={};var fanobjs=[];fanTools.getFans=function(params){params.nosession=1;var url='/api/fans';if(!params.userid){url=geekAPIUrls.fans;delete params.userid;}
return loadingTracker.addPromise($http.get(url,{params:params,cache:true})).then(function(response){var fanobj;if(_.some(fanobjs,{params:params})){fanobj=_.find(fanobjs,{params:params})}else{fanobj=response.data;fanobj.params=params;fanobjs.push(fanobj);}
return fanobj;});};fanTools.createFan=function(params){return loadingTracker.addPromise($http.post('/api/fans',params)).then(function(response){var fanobj=_.find(fanobjs,{params:{objecttype:params.objecttype,objectid:params.objectid}});if(fanobj){fanobj.fanid=response.data.fanid;fanobj.numfans+=1;}});};fanTools.deleteFan=function(fanid){return loadingTracker.addPromise($http.delete('/api/fans/'+fanid)).then(function(){var fanobj=_.find(fanobjs,{fanid:fanid});if(fanobj){delete fanobj.fanid;fanobj.numfans-=1;}});};return fanTools;}]);geekApp.directive('geekitemFans',[function(){return{restrict:'E',templateUrl:'geekitem_toolbar_actions_fan.tpl',controller:'GeekItemFanCtrl',controllerAs:'$fanctrl',bindToController:true,scope:{buttontype:'='}}}]);geekApp.controller('GeekItemFanCtrl',['fanHttpTools','geekitemParams','userid',function(fanHttpTools,geekitemParams,userid){this.fanobj={};this.params={};this.init=function(){this.params={'objecttype':geekitemParams.objecttype,'objectid':geekitemParams.objectid};this.loading=true;var getParams=angular.copy(this.params);getParams.userid=userid;var that=this;fanHttpTools.getFans(getParams).then(function(fanobj){that.fanobj=fanobj;that.loading=false;});};this.toggleFan=function(){if(this.fanobj.fanid){fanHttpTools.deleteFan(this.fanobj.fanid);}else{fanHttpTools.createFan(this.params);}};this.$onInit=function(){this.init();}}]);
geekApp.controller('GeekItem_LinkedItemsCtrl',['$state','geekitem','geekitemParams','linkeditemsTabs',function($state,geekitem,geekitemParams,linkeditemsTabs){var that=this;this.tabData=[];switch(geekitemParams.subtype){case'boardgame':case'boardgameaccessory':case'boardgameexpansion':this.tabData=linkeditemsTabs['boardgame'];break;case'boardgamedesigner':case'boardgameartist':this.tabData=linkeditemsTabs['boardgameperson'];break;case'boardgamepublisher':this.tabData=linkeditemsTabs['boardgamepublisher'];break;case'boardgamecategory':case'boardgamemechanic':case'boardgamefamily':this.tabData=linkeditemsTabs['boardgameproperty'];break;}
var params=angular.copy(geekitemParams);params.linkshowcount=6;var geekitemobj=new geekitem(params);geekitemobj.getItem().then(function(response){that.tabData.forEach(function(tab){tab.href=$state.href(tab.route);if(response.data.item.linkcounts&&response.data.item.linkcounts[tab.linkkey])
tab.count=response.data.item.linkcounts[tab.linkkey];});});}]);
geekApp.directive('itemPollButton',['$uibModal',function($modal,geekitem){var link=function(scope,elem,attr){scope.itempolltype=attr.itemPollButton;scope.pollView=attr.pollView;elem.on('click',function(){$modal.open({'controller':'ItemPollController','scope':scope,'windowClass':'modal-record-play modal-fixed-right','templateUrl':"geekitem_poll.tpl"});});};return{link:link,restrict:'A',scope:{}}}]);geekApp.controller('PollResultElement',['$scope','$filter',function($scope,$filter){$scope.result=$filter('filter')($scope.question.results.results,{choiceidcolumn:$scope.column.choiceid,choiceidrow:$scope.row.choiceid})[0];}]);geekApp.controller('ItemPollController',['geekitemParams','$http','$scope',function(geekitemParams,$http,$scope){$scope.poll={};$scope.vote={};var args={'action':'view',itempolltype:$scope.itempolltype,objecttype:geekitemParams.objecttype,objectid:geekitemParams.objectid};$scope.clear=function(){$http.post('geekpoll.php',{pollid:$scope.poll.poll.pollid,action:'clear'}).then(function(){resetVote();resetPoll();})};$scope.showResults=function(){$http.get('geekpoll.php',{params:{pollid:$scope.poll.poll.pollid,action:'results'}}).then(function(result){$scope.results=result.data;});};$scope.answered=function(){return _.some($scope.poll.pollquestions,function(question){return question.answers.length>0;});};$scope.submit=function(){$http.post('/poll/answer',$scope.vote).then(function(result){$scope.results=result.data;resetPoll();});};$scope.questions=function(){$scope.results=null;};var resetVote=function(){$scope.vote={pollid:$scope.poll.poll.pollid,action:'answer'};};var resetPoll=function(firstRun){$http.get('/geekitempoll.php',{params:args}).then(function(result){$scope.poll=result.data;$scope.vote={pollid:result.data.poll.pollid,action:'answer'};result.data.pollquestions.forEach(function(question){question.answers.forEach(function(answer){$scope.vote['q'+answer.questionid+'r'+answer.choiceidrow]='c'+answer.choiceidcolumn+'r'+answer.choiceidrow;});});if(firstRun&&$scope.pollView=='results'){$scope.results=true;$scope.showResults();}});};resetPoll(true);}]);geekApp.directive('pollQuestion',[function(){var link=function(scope,elem,attr){};return{link:link,restrict:'E',templateUrl:function(elem,attr){return"pollquestion-"+attr.ngQuestionformat+".html";}}}]);geekApp.directive('pollQuestionResults',[function(){var link=function(scope,elem,attr){};return{link:link,restrict:'E',templateUrl:function(elem,attr){return"pollquestion-results-"+attr.ngQuestionformat+".html";}}}]);
geekApp.directive('geekitemRecordPlay',[function(){return{restrict:'E',templateUrl:'geekitem_toolbar_actions_recordplay.tpl',controller:'GeekItemRecordPlayCtrl',controllerAs:'$recordplayctrl',bindToController:true}}]);geekApp.controller('GeekItemRecordPlayCtrl',['geekitemParams',function(geekitemParams){this.params={};this.init=function(){this.params={'objecttype':geekitemParams.objecttype,'objectid':geekitemParams.objectid};};this.$onInit=function(){this.init();}}]);
geekApp.factory('geekitemSettingsHttpTools',['$http',function($http){var tools={};tools.saveSettings=function(params){return $http.post('/api/geekitemsettings',params);};return tools;}]);geekApp.controller('GeekItem_EditSettingsCtrl',['geekitemSettingsHttpTools','$uibModalInstance','settings','modules','notify',function(geekitemSettingsHttpTools,$uibModalInstance,settings,modules,notify){var that=this;this.$onInit=function(){that.settings=settings;that.modules=modules;that.moduleEditList=[];_.each(settings.modules.boardgame,function(module){that.moduleEditList.push(module);});};this.save=function(){geekitemSettingsHttpTools.saveSettings(that.settings).then(function(response){notify.closeAll();notify("Settings Saved");});};this.close=function(){that.settings.modules.boardgame=that.moduleEditList;$uibModalInstance.dismiss();window.location.reload();}}]);
geekApp.controller('GeekItem_OverviewCtrl',['$scope','geekitemSettings','geekitemModules','adBlock',function($scope,geekitemSettings,geekitemModules,adBlock){var that=this;this.geekitemSettings=geekitemSettings;this.getTemplateHtml=function(){var output='';_.forEach(geekitemSettings.modules[this.moduleindex],function(module,key){if(!module.enabled)
return;if(module.adblock&&adBlock[module.adblock])
return;var md=_.find(geekitemModules,{name:module.name});if(md)
output+=md.html;if(key===0){md=_.find(geekitemModules,{name:'textad'});if(md)
output+=md.html;}});return output;}}]);
window.lzld||function(e,d){function m(){n=!0;f();setTimeout(f,25)}function p(a){var b=0;return function(){var c=+new Date;20>c-b||(b=c,a.apply(this,arguments))}}function h(a,b,c){a.attachEvent?a.attachEvent&&a.attachEvent("on"+b,c):a.addEventListener(b,c,!1)}function k(a,b,c){a.detachEvent?a.detachEvent&&a.detachEvent("on"+b,c):a.removeEventListener(b,c,!1)}function q(a,b){return y(d.documentElement,a)&&a.getBoundingClientRect().top<r+200?(a.onload=null,a.removeAttribute("onload"),a.src=a.getAttribute("data-frz-src"),a.removeAttribute("data-frz-src"),g[b]=null,!0):!1}function s(){return 0<d.documentElement.clientHeight?d.documentElement.clientHeight:d.body&&0<d.body.clientHeight?d.body.clientHeight:0<e.innerHeight?e.innerHeight:200}function t(){var a=g.length,b,c=!0;for(b=0;b<a;b++){var d=g[b];null===d||q(d,b)||(c=!1)}c&&n&&(l=!0,k(e,"resize",u),k(e,"scroll",f),k(e,"touchmove",f),k(e,"load",m))}function v(){l=!1;h(e,"resize",u);h(e,"scroll",f);h(e,"touchmove",f)}function z(){var a=HTMLImageElement.prototype.getAttribute;HTMLImageElement.prototype.getAttribute=function(b){return"src"===b?a.call(this,"data-frz-src")||a.call(this,b):a.call(this,b)}}function w(a,b){var c,d;if(b){if(Array.prototype.indexOf)return Array.prototype.indexOf.call(b,a,c);d=b.length;for(c=c?0>c?Math.max(0,d+c):c:0;c<d;c++)if(c in b&&b[c]===a)return c}return-1}var r=s(),g=[],n=!1,l=!1,u=p(function(){r=s()}),f=p(t);e.HTMLImageElement&&z();e.lzld=function(a){-1===w(a,g)&&(l&&v(),q(a,g.push(a)-1))};(function(a){function b(c){if("readystatechange"!==c.type||"complete"===d.readyState)k("load"===c.type?e:d,c.type,b),f||(f=!0,a())}function c(){try{d.documentElement.doScroll("left")}catch(a){setTimeout(c,50);return}b("poll")}var f=!1,g=!0;if("complete"===d.readyState)a();else{if(d.createEventObject&&d.documentElement.doScroll){try{g=!e.frameElement}catch(l){}g&&c()}h(d,"DOMContentLoaded",b);h(d,"readystatechange",b);h(e,"load",b)}})(function(){for(var a=d.getElementsByTagName("img"),b,c=0,e=a.length;c<e;c+=1)b=a[c],b.getAttribute("data-frz-src")&&-1===w(b,g)&&g.push(b);t();setTimeout(f,25)});h(e,"load",m);v();var y=d.documentElement.compareDocumentPosition?function(a,b){return!!(a.compareDocumentPosition(b)&16)}:d.documentElement.contains?function(a,b){return a!==b&&(a.contains?a.contains(b):!1)}:function(a,b){for(;b=b.parentNode;)if(b===a)return!0;return!1}}(this,document);
